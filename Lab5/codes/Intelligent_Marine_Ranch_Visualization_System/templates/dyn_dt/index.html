{% extends 'layouts/base.html' %}

{% block title %} 水产养殖数据监控平台 {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
  .loading-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top: 4px solid #5e72e4;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .dashboard-card {
    transition: all 0.3s ease;
    height: 100%;
  }

  .dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
  }

  .card-stat {
    font-size: 2rem;
    font-weight: bold;
  }

  .parameter-badge {
    background-color: #f6f9fc;
    color: #525f7f;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    display: inline-block;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .parameter-badge:hover,
  .parameter-badge.active {
    background-color: #5e72e4;
    color: white;
  }

  .station-item {
    padding: 0.5rem;
    border-radius: 0.375rem;
    margin-bottom: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .station-item:hover,
  .station-item.active {
    background-color: #f6f9fc;
  }

  .water-quality-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
  }

  .quality-I {
    background-color: #2dce89;
  }

  .quality-II {
    background-color: #11cdef;
  }

  .quality-III {
    background-color: #fb6340;
  }

  .quality-IV {
    background-color: #f5365c;
  }

  .quality-V {
    background-color: #8965e0;
  }

  .quality-劣V {
    background-color: #172b4d;
  }

  .chart-container {
    min-height: 300px;
    position: relative;
  }

  .comparison-table {
    font-size: 0.875rem;
  }

  .comparison-table th,
  .comparison-table td {
    padding: 0.5rem;
  }

  .map-container {
    height: 400px;
    background-color: #f6f9fc;
    border-radius: 0.375rem;
  }

  /* 让下拉菜单在较小屏幕上也能完整显示 */
  @media (max-width: 768px) {
    .station-dropdown {
      max-height: 200px;
      overflow-y: auto;
    }
  }

  /* 数据管理按钮样式 */
  .data-management-buttons {
    margin-right: 15px;
  }

  .data-management-buttons .btn {
    margin-left: 5px;
  }
  
  .special_modal-title {
    color: #343a40 !important; /* 黑灰色 */
  }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="min-height-300 bg-primary position-absolute w-100"></div>

{% include "includes/sidenav.html" %}

<main class="main-content position-relative border-radius-lg">
  {% include "includes/navigation.html" %}

  <div class="container-fluid py-4">
    <!-- 顶部统计卡片 -->
    <div class="row mb-4">
      <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
        <div class="card dashboard-card">
          <div class="card-body p-3">
            <div class="row">
              <div class="col-8">
                <div class="numbers">
                  <p class="text-sm mb-0 text-uppercase font-weight-bold">监测站点数量</p>
                  <h5 class="font-weight-bolder card-stat" id="stations-count">127</h5>
                  <p class="mb-0 text-sm">
                    <span class="text-success text-sm font-weight-bolder">+5%</span>
                    较上月新增
                  </p>
                </div>
              </div>
              <div class="col-4 text-end">
                <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                  <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
        <div class="card dashboard-card">
          <div class="card-body p-3">
            <div class="row">
              <div class="col-8">
                <div class="numbers">
                  <p class="text-sm mb-0 text-uppercase font-weight-bold">水质正常站点比例</p>
                  <h5 class="font-weight-bolder card-stat" id="normal-stations">85%</h5>
                  <p class="mb-0 text-sm">
                    <span class="text-success text-sm font-weight-bolder">+3%</span>
                    较上月提升
                  </p>
                </div>
              </div>
              <div class="col-4 text-end">
                <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                  <i class="ni ni-check-bold text-lg opacity-10" aria-hidden="true"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
        <div class="card dashboard-card">
          <div class="card-body p-3">
            <div class="row">
              <div class="col-8">
                <div class="numbers">
                  <p class="text-sm mb-0 text-uppercase font-weight-bold">鱼类数据样本数</p>
                  <h5 class="font-weight-bolder card-stat" id="fish-samples">159</h5>
                  <p class="mb-0 text-sm">
                    <span class="text-success text-sm font-weight-bolder">+12%</span>
                    较去年同期增长
                  </p>
                </div>
              </div>
              <div class="col-4 text-end">
                <div class="icon icon-shape bg-gradient-info shadow-info text-center rounded-circle">
                  <i class="ni ni-chart-bar-32 text-lg opacity-10" aria-hidden="true"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 数据管理按钮 -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-end">
          <div class="data-management-buttons">
            <button id="export-charts-btn" class="btn btn-sm btn-info">
              <i class="ni ni-image me-1"></i> 导出图表
            </button>
            <button id="upload-data-btn" class="btn btn-sm btn-primary">
              <i class="ni ni-cloud-upload-96 me-1"></i> 上传数据
            </button>
            <button id="export-data-btn" class="btn btn-sm btn-success">
              <i class="ni ni-cloud-download-95 me-1"></i> 导出数据
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 主要内容 -->
    <div class="row mb-4">
      <!-- 左侧控制面板 -->
      <div class="col-lg-4 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100">
          <div class="card-header pb-0 pt-3 bg-transparent">
            <h6 class="text-capitalize">监测点选择</h6>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <label class="form-label">选择省份</label>
              <select class="form-control" id="province-select">
                <option value="">加载中...</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">选择流域</label>
              <select class="form-control" id="basin-select">
                <option value="">请先选择省份</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">选择监测站点</label>
              <select class="form-control" id="station-select">
                <option value="">请先选择流域</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">选择月份</label>
              <select class="form-control" id="month-select">
                <option value="">请先选择监测站点</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">选择水质参数</label>
              <div id="parameter-badges" class="d-flex flex-wrap">
                <div class="loading-indicator">
                  <div class="loading-spinner"></div>
                </div>
              </div>
            </div>
            <button id="load-water-data" class="btn btn-primary btn-lg w-100">加载水质数据</button>
          </div>
        </div>
      </div>

      <!-- 右侧水质趋势图 -->
      <div class="col-lg-8">
        <div class="card z-index-2 h-100">
          <div class="card-header pb-0 pt-3 bg-transparent d-flex justify-content-between align-items-center">
            <h6 class="text-capitalize mb-0">水质参数趋势</h6>
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-outline-primary active" data-chart-type="line">折线图</button>
              <button type="button" class="btn btn-sm btn-outline-primary" data-chart-type="bar">柱状图</button>
            </div>
          </div>
          <div class="card-body p-3">
            <div class="chart-container">
              <div id="water-trend-loading" class="loading-indicator">
                <div class="loading-spinner"></div>
              </div>
              <canvas id="water-trend-chart" class="chart-canvas" style="display:none;"></canvas>
            </div>
            <div class="mt-3" id="trend-stats-container" style="display:none;">
              <div class="row">
                <div class="col-md-3 col-6">
                  <div class="border-start border-start-info py-2 px-3">
                    <p class="text-xs text-muted mb-0">最小值</p>
                    <h6 class="text-sm mb-0" id="trend-min">--</h6>
                  </div>
                </div>
                <div class="col-md-3 col-6">
                  <div class="border-start border-start-info py-2 px-3">
                    <p class="text-xs text-muted mb-0">最大值</p>
                    <h6 class="text-sm mb-0" id="trend-max">--</h6>
                  </div>
                </div>
                <div class="col-md-3 col-6">
                  <div class="border-start border-start-info py-2 px-3">
                    <p class="text-xs text-muted mb-0">平均值</p>
                    <h6 class="text-sm mb-0" id="trend-avg">--</h6>
                  </div>
                </div>
                <div class="col-md-3 col-6">
                  <div class="border-start border-start-info py-2 px-3">
                    <p class="text-xs text-muted mb-0">标准差</p>
                    <h6 class="text-sm mb-0" id="trend-std">--</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 下方内容 -->
    <div class="row mb-4">
      <!-- 鱼类数据 -->
      <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100">
          <div class="card-header pb-0 pt-3 bg-transparent">
            <div class="d-flex justify-content-between">
              <h6 class="text-capitalize mb-0">鱼类数据分布</h6>
            </div>
            <div class="row mt-3">
              <div class="col-6">
                <label class="form-label">选择鱼类</label>
                <select class="form-control" id="speciesSelect">
                  <option value="Bream">欧鲷 (Bream)</option>
                  <option value="Roach">拟鲤 (Roach)</option>
                  <option value="Whitefish">白鲑 (Whitefish)</option>
                  <option value="Parkki">帕尔基鱼 (Parkki)</option>
                  <option value="Perch">鲈鱼 (Perch)</option>
                  <option value="Pike">梭子鱼 (Pike)</option>
                  <option value="Smelt">胡瓜鱼 (Smelt)</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">选择参数</label>
                <select class="form-control" id="parameterSelect">
                  <option value="Weight(g)">体重 (g)</option>
                  <option value="Length1(cm)">标准体长 (cm)</option>
                  <option value="Length2(cm)">叉长 (cm)</option>
                  <option value="Length3(cm)">总长 (cm)</option>
                  <option value="Height(cm)">体高 (cm)</option>
                  <option value="Width(cm)">体宽 (cm)</option>
                </select>
              </div>
            </div>
            <button id="loadDataBtn" class="btn btn-primary mt-3 w-100">加载鱼类数据</button>
          </div>
          <div class="card-body p-3">
            <div class="chart-container">
              <canvas id="fishChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- 水质统计 -->
      <div class="col-lg-6">
        <div class="card z-index-2 h-100">
          <div class="card-header pb-0 pt-3 bg-transparent">
            <h6 class="text-capitalize mb-0">水质类别统计</h6>
          </div>
          <div class="card-body p-3">
            <div class="row align-items-center mb-3">
              <div class="col-md-6">
                <div class="chart-container">
                  <canvas id="water-quality-pie-chart"></canvas>
                </div>
              </div>
              <div class="col-md-6">
                <div id="water-quality-legend">
                  <div class="d-flex align-items-center mb-2">
                    <div class="water-quality-indicator quality-I"></div>
                    <span>I类 - 适合源头水、国家自然保护区</span>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <div class="water-quality-indicator quality-II"></div>
                    <span>II类 - 适合集中式生活饮用水</span>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <div class="water-quality-indicator quality-III"></div>
                    <span>III类 - 适合鱼类保护区、游泳区</span>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <div class="water-quality-indicator quality-IV"></div>
                    <span>IV类 - 适合一般工业用水区</span>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <div class="water-quality-indicator quality-V"></div>
                    <span>V类 - 适合农业用水区</span>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="water-quality-indicator quality-劣V"></div>
                    <span>劣V类 - 基本无使用功能</span>
                  </div>
                </div>
              </div>
            </div>
            <div id="station-status-container" class="mt-4">
              <h6 class="text-uppercase text-muted text-sm font-weight-bolder">监测站点状态</h6>
              <div class="progress-wrapper">
                <div class="progress-info">
                  <div class="progress-percentage">
                    <span id="normal-status-percent">正常: 85%</span>
                  </div>
                </div>
                <div class="progress">
                  <div class="progress-bar bg-success" id="normal-status-bar" role="progressbar" aria-valuenow="85"
                    aria-valuemin="0" aria-valuemax="100" style="width: 85%;"></div>
                </div>
              </div>
              <div class="progress-wrapper">
                <div class="progress-info">
                  <div class="progress-percentage">
                    <span id="maintenance-status-percent">维护/停站: 15%</span>
                  </div>
                </div>
                <div class="progress">
                  <div class="progress-bar bg-warning" id="maintenance-status-bar" role="progressbar" aria-valuenow="15"
                    aria-valuemin="0" aria-valuemax="100" style="width: 15%;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 底部内容 -->
    <div class="row">
      <!-- 站点对比 -->
      <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="card">
          <div class="card-header pb-0 p-3">
            <div class="d-flex justify-content-between">
              <h6 class="mb-2">站点参数对比</h6>
            </div>
          </div>
          <div class="card-body p-3">
            <div id="stations-comparison-loading" class="loading-indicator">
              <div class="loading-spinner"></div>
            </div>
            <div class="table-responsive" id="stations-comparison-table" style="display:none;">
              <table class="table align-items-center comparison-table">
                <thead>
                  <tr>
                    <th>站点名称</th>
                    <th>平均值</th>
                    <th>最小值</th>
                    <th>最大值</th>
                    <th>标准差</th>
                  </tr>
                </thead>
                <tbody id="comparison-tbody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 流域概览 -->
      <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="card">
          <div class="card-header pb-0 p-3">
            <h6 class="mb-0">流域水质概览</h6>
          </div>
          <div class="card-body p-3">
            <div id="basin-overview-loading" class="loading-indicator">
              <div class="loading-spinner"></div>
            </div>
            <div id="basin-overview-container" style="display:none;">
              <canvas id="basin-overview-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- 上传数据模态框 -->
<div class="modal fade" id="uploadDataModal" tabindex="-1" role="dialog" aria-labelledby="uploadDataModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <form id="uploadDataForm" enctype="multipart/form-data">
          <div class="mb-3">
            <select class="form-control" id="upload-province" name="province" required>
              <option value="">请选择省份</option>
            </select>
          </div>
          <div class="mb-3">
            <select class="form-control" id="upload-basin" name="basin" required>
              <option value="">请先选择省份</option>
            </select>
          </div>
          <div class="mb-3">
            <select class="form-control" id="upload-station" name="station" required>
              <option value="">请先选择流域</option>
            </select>
              <div class="form-text">
                <a href="#" id="create-new-station" class="text-dark" style="color: #343a40 !important; text-decoration: none;">+ 创建新站点</a>
              </div>
          </div>
          <div id="new-station-container" style="display: none;">
            <div class="mb-3">
              <label for="new-station-name" class="form-label" style="color: #343a40 !important; text-decoration: none;">新站点名称</label>
              <input type="text" class="form-control" id="new-station-name" name="new_station">
            </div>
          </div>
          <div class="mb-3">
            <input type="month" class="form-control" id="upload-month" name="month" required>
          </div>
          <div class="mb-3">
            <input type="file" class="form-control" id="upload-file" name="file" accept=".csv" required>
            <div class="form-text">请上传符合格式要求的CSV文件，包含必要的列：省份、流域、断面名称、监测时间、水质类别</div>
          </div>
          <div class="alert alert-info bg-white text-white border-0">
            <h6 class="text-white">CSV格式示例</h6>
            <pre class="text-white" style="font-size: 0.8rem;">省份,流域,断面名称,监测时间,水质类别,水温(℃),pH(无量纲),溶解氧(mg/L)
上海市,长江流域,七效港西桥,04-01 12:00,Ⅲ,17.3,7.99,8.64</pre>
          </div>
        </form>
        <div id="upload-progress" class="progress mt-3" style="display: none;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">
          </div>
        </div>
        <div id="upload-result" class="alert mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="upload-submit-btn">上传</button>
      </div>
    </div>
  </div>
</div>

<!-- 导出数据模态框 -->
<div class="modal fade" id="exportDataModal" tabindex="-1" role="dialog" aria-labelledby="exportDataModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <form id="exportDataForm">
          <div class="mb-3">
            <select class="form-control" id="export-province" name="province" required>
              <option value="">请选择省份</option>
            </select>
          </div>
          <div class="mb-3">
            <select class="form-control" id="export-basin" name="basin" required>
              <option value="">请先选择省份</option>
            </select>
          </div>
          <div class="mb-3">
            <select class="form-control" id="export-station" name="station" required>
              <option value="">请先选择流域</option>
            </select>
          </div>
          <div class="mb-3">
            <select class="form-control" id="export-month" name="month" required>
              <option value="">请先选择监测站点</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="export-submit-btn">导出</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exportChartsModal" tabindex="-1" role="dialog" aria-labelledby="exportChartsModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <form id="exportChartsForm">
          <div class="mb-3">
            <label class="form-label" style="color: #343a40 !important; text-decoration: none;">图表布局</label>
            <select class="form-control" id="export-layout">
              <option value="2x2">2x2 (默认)</option>
              <option value="1x4">1x4 (垂直)</option>
              <option value="4x1">4x1 (水平)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" style="color: #343a40 !important; text-decoration: none;">图片格式</label>
            <select class="form-control" id="export-format">
              <option value="png">PNG</option>
              <option value="jpeg">JPEG</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" style="color: #343a40 !important; text-decoration: none;">图片质量</label>
            <input type="range" class="form-range" id="export-quality" min="0.1" max="1.0" step="0.1" value="0.9">
            <div class="d-flex justify-content-between", style="color: #343a40 !important; text-decoration: none;">
              <small>低质量</small>
              <small>高质量</small>
            </div>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="export-include-title" checked>
            <label class="form-check-label" for="export-include-title" style="color: #343a40 !important; text-decoration: none;">包含标题和信息</label>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="export-include-watermark" checked>
            <label class="form-check-label" for="export-include-watermark" style="color: #343a40 !important; text-decoration: none;">包含水印</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="export-charts-confirm-btn">导出</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}



<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0/dist/chartjs-adapter-luxon.min.js"></script>

<script>
  // ============= 全局变量 ===============
  let waterTrendChart = null;
  let fishChart = null;
  let waterQualityPieChart = null;
  let basinOverviewChart = null;

  // 默认选项设置
  const DEFAULT_PROVINCE = "上海市";
  const DEFAULT_BASIN = "长江流域";
  const DEFAULT_STATION = "吴淞口";
  const DEFAULT_MONTH = "2021-04";
  const DEFAULT_PARAMETER = "pH";

  // 参数映射表
  const parameterMapping = {
    "Weight(g)": "体重 (g)",
    "Length1(cm)": "标准体长 (cm)",
    "Length2(cm)": "叉长 (cm)",
    "Length3(cm)": "总长 (cm)",
    "Height(cm)": "体高 (cm)",
    "Width(cm)": "体宽 (cm)"
  };

  // 鱼类映射表
  const speciesMapping = {
    "Bream": "欧鲷 (Bream)",
    "Roach": "拟鲤 (Roach)",
    "Whitefish": "白鲑 (Whitefish)",
    "Parkki": "帕尔基鱼 (Parkki)",
    "Perch": "鲈鱼 (Perch)",
    "Pike": "梭子鱼 (Pike)",
    "Smelt": "胡瓜鱼 (Smelt)"
  };

  // 水质类别颜色
  const waterQualityColors = {
    "Ⅰ": "rgba(45, 206, 137, 0.8)",
    "I": "rgba(45, 206, 137, 0.8)",
    "Ⅱ": "rgba(17, 205, 239, 0.8)",
    "II": "rgba(17, 205, 239, 0.8)",
    "Ⅲ": "rgba(251, 99, 64, 0.8)",
    "III": "rgba(251, 99, 64, 0.8)",
    "Ⅳ": "rgba(245, 54, 92, 0.8)",
    "IV": "rgba(245, 54, 92, 0.8)",
    "Ⅴ": "rgba(137, 101, 224, 0.8)",
    "V": "rgba(137, 101, 224, 0.8)",
    "劣Ⅴ": "rgba(23, 43, 77, 0.8)",
    "劣V": "rgba(23, 43, 77, 0.8)"
  };

  // ============= 工具函数 ===============

  /**
   * 显示加载指示器
   * @param {string} elementId - 加载指示器的元素ID
   */
  function showLoading(elementId) {
    document.getElementById(elementId).style.display = 'flex';
  }

  /**
   * 隐藏加载指示器
   * @param {string} elementId - 加载指示器的元素ID
   */
  function hideLoading(elementId) {
    document.getElementById(elementId).style.display = 'none';
  }

  /**
   * 格式化数字，保留指定小数位
   * @param {number} value - 要格式化的数字
   * @param {number} decimals - 小数位数
   * @returns {string} 格式化后的数字字符串
   */
  function formatNumber(value, decimals = 2) {
    if (value === undefined || value === null) return '--';
    return Number(value).toFixed(decimals);
  }

  /**
   * 获取安全的颜色索引
   * @param {number} index - 索引值
   * @param {Array} colorArray - 颜色数组
   * @returns {string} 颜色值
   */
  function getSafeColorIndex(index, colorArray) {
    return colorArray[index % colorArray.length];
  }

  /**
   * 获取随机颜色
   * @param {number} alpha - 透明度
   * @returns {string} RGBA颜色字符串
   */
  function getRandomColor(alpha = 0.7) {
    const r = Math.floor(Math.random() * 200) + 20;
    const g = Math.floor(Math.random() * 200) + 20;
    const b = Math.floor(Math.random() * 200) + 20;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  /**
   * 设置下拉框的选项并选中指定值
   * @param {string} selectId - 下拉框元素ID
   * @param {Array} options - 选项数组
   * @param {string} selectedValue - 要选中的值
   * @param {Function} textFunction - 从选项中获取文本的函数
   */
  function setSelectOptions(selectId, options, selectedValue, textFunction = (opt) => opt) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';

    options.forEach(option => {
      const optionEl = document.createElement('option');
      optionEl.value = typeof option === 'object' ? option.value || option.name : option;
      optionEl.textContent = textFunction(option);
      select.appendChild(optionEl);
    });

    if (selectedValue) {
      select.value = selectedValue;
    }
  }

  // ============= 鱼类数据相关 ===============

  /**
   * 加载鱼类统计数据
   */
  function loadFishStats() {
    fetch('/dyn_dt/api/fish/list')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 计算总样本数
          fetch(`/dyn_dt/api/fish/comparison?parameter=Weight(g)`)
            .then(response => response.json())
            .then(comparisonData => {
              if (comparisonData.success) {
                let totalSamples = 0;
                comparisonData.comparison.forEach(item => {
                  totalSamples += item.count;
                });
                document.getElementById('fish-samples').textContent = totalSamples;
              }
            })
            .catch(error => console.error('Error loading fish stats:', error));
        }
      })
      .catch(error => console.error('Error loading fish species:', error));
  }

  /**
   * 加载鱼类数据分布
   */
  function loadFishDistribution() {
    const species = document.getElementById("speciesSelect").value;
    const parameter = document.getElementById("parameterSelect").value;

    fetch(`/dyn_dt/api/fish/distribution?species=${species}&parameter=${parameter}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (fishChart instanceof Chart) {
            fishChart.destroy();
          }

          const ctx = document.getElementById('fishChart').getContext('2d');

          fishChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.distribution.labels,
              datasets: [{
                label: `${speciesMapping[species]} - ${parameterMapping[parameter]}`,
                data: data.distribution.values,
                backgroundColor: 'rgba(94, 114, 228, 0.7)',
                borderColor: 'rgba(94, 114, 228, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: {
                duration: 1000,
                easing: 'easeOutQuart'
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: parameterMapping[parameter]
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: '数量'
                  },
                  beginAtZero: true
                }
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `数量: ${context.raw}`;
                    }
                  }
                }
              }
            }
          });
        }
      })
      .catch(error => {
        console.error("Error fetching fish distribution data: ", error);
      });
  }

  // ============= 水质数据相关 ===============

  /**
   * 加载省份列表并选择默认省份
   */
  function loadProvinces() {
    fetch('/dyn_dt/api/water/provinces')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const provinceSelect = document.getElementById('province-select');
          provinceSelect.innerHTML = '<option value="">请选择省份</option>';

          data.provinces.forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            provinceSelect.appendChild(option);
          });

          // 设置默认省份并加载相应的流域
          if (data.provinces.includes(DEFAULT_PROVINCE)) {
            provinceSelect.value = DEFAULT_PROVINCE;
            loadBasins(DEFAULT_PROVINCE);
          }

          // 计算站点总数
          let totalStations = 0;
          let promises = data.provinces.map(province =>
            fetch(`/dyn_dt/api/water/stations?province=${province}`)
              .then(response => response.json())
              .then(stationData => {
                if (stationData.success) {
                  totalStations += stationData.total;
                }
              })
          );

          Promise.all(promises).then(() => {
            document.getElementById('stations-count').textContent = totalStations;
            // 估计一个正常站点比例
            const normalPercent = Math.floor(Math.random() * 20) + 75; // 75% - 95%
            document.getElementById('normal-stations').textContent = normalPercent + '%';
          });
        }
      })
      .catch(error => console.error('Error loading provinces:', error));
  }

  /**
   * 加载流域列表并选择默认流域
   * @param {string} province - 省份名称
   */
  function loadBasins(province) {
    const basinSelect = document.getElementById('basin-select');
    basinSelect.innerHTML = '<option value="">加载中...</option>';

    fetch(`/dyn_dt/api/water/basins?province=${province}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          basinSelect.innerHTML = '<option value="">请选择流域</option>';

          data.basins.forEach(basin => {
            const option = document.createElement('option');
            option.value = basin;
            option.textContent = basin;
            basinSelect.appendChild(option);
          });

          // 设置默认流域并加载相应的站点
          if (data.basins.includes(DEFAULT_BASIN)) {
            basinSelect.value = DEFAULT_BASIN;
            loadStations(province, DEFAULT_BASIN);
          }
        }
      })
      .catch(error => {
        console.error('Error loading basins:', error);
        basinSelect.innerHTML = '<option value="">加载失败，请重试</option>';
      });
  }

  /**
   * 加载站点列表并选择默认站点
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   */
  function loadStations(province, basin) {
    const stationSelect = document.getElementById('station-select');
    stationSelect.innerHTML = '<option value="">加载中...</option>';

    fetch(`/dyn_dt/api/water/stations?province=${province}&basin=${basin}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          stationSelect.innerHTML = '<option value="">请选择监测站点</option>';

          data.stations.forEach(station => {
            const option = document.createElement('option');
            option.value = station.name;
            option.textContent = station.name;
            stationSelect.appendChild(option);
          });

          // 设置默认站点并加载相应的月份
          if (data.stations.some(s => s.name === DEFAULT_STATION)) {
            stationSelect.value = DEFAULT_STATION;
            loadAvailableMonths(province, basin, DEFAULT_STATION);
          } else if (data.stations.length > 0) {
            // 如果没有默认站点，选择第一个站点
            stationSelect.value = data.stations[0].name;
            loadAvailableMonths(province, basin, data.stations[0].name);
          }
        }
      })
      .catch(error => {
        console.error('Error loading stations:', error);
        stationSelect.innerHTML = '<option value="">加载失败，请重试</option>';
      });
  }

  /**
   * 加载可用月份并选择默认月份
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   * @param {string} station - 站点名称
   */
  function loadAvailableMonths(province, basin, station) {
    const monthSelect = document.getElementById('month-select');
    monthSelect.innerHTML = '<option value="">加载中...</option>';

    fetch(`/dyn_dt/api/water/available_months?province=${province}&basin=${basin}&station=${station}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          monthSelect.innerHTML = '<option value="">请选择月份</option>';

          data.available_months.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            monthSelect.appendChild(option);
          });

          // 设置默认月份并加载参数列表
          if (data.available_months.includes(DEFAULT_MONTH)) {
            monthSelect.value = DEFAULT_MONTH;
          } else if (data.available_months.length > 0) {
            // 如果没有默认月份，选择第一个月份
            monthSelect.value = data.available_months[0];
          }

          // 加载参数列表
          loadWaterParameters();
        }
      })
      .catch(error => {
        console.error('Error loading available months:', error);
        monthSelect.innerHTML = '<option value="">加载失败，请重试</option>';
      });
  }

  /**
   * 加载水质参数列表并选择默认参数
   */
  function loadWaterParameters() {
    const parameterBadgesContainer = document.getElementById('parameter-badges');
    parameterBadgesContainer.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div></div>';

    fetch('/dyn_dt/api/water/parameters')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          parameterBadgesContainer.innerHTML = '';

          data.parameters.forEach(param => {
            if (param.id !== '叶绿素α' && param.id !== '藻密度') { // 排除一些参数
              const badge = document.createElement('div');
              badge.className = 'parameter-badge';
              badge.dataset.parameterId = param.id;
              badge.textContent = param.name;

              badge.addEventListener('click', function () {
                // 切换选中状态
                const allBadges = document.querySelectorAll('.parameter-badge');
                allBadges.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
              });

              parameterBadgesContainer.appendChild(badge);

              // 设置默认参数
              if (param.id === DEFAULT_PARAMETER) {
                badge.classList.add('active');
              }
            }
          });

          // 如果没有找到默认参数，选择第一个参数
          if (!document.querySelector('.parameter-badge.active')) {
            const firstBadge = document.querySelector('.parameter-badge');
            if (firstBadge) {
              firstBadge.classList.add('active');
            }
          }

          // 自动加载水质数据
          loadWaterTrendData();
        }
      })
      .catch(error => {
        console.error('Error loading water parameters:', error);
        parameterBadgesContainer.innerHTML = '<div class="alert alert-danger">加载参数失败，请重试</div>';
      });
  }

  /**
   * 加载水质趋势数据
   */
  function loadWaterTrendData() {
    const province = document.getElementById('province-select').value;
    const basin = document.getElementById('basin-select').value;
    const station = document.getElementById('station-select').value;
    const month = document.getElementById('month-select').value;
    const parameterBadge = document.querySelector('.parameter-badge.active');

    if (!province || !basin || !station || !month || !parameterBadge) {
      console.warn('数据筛选条件不完整，无法加载水质趋势数据');
      return;
    }

    const parameter = parameterBadge.dataset.parameterId;

    showLoading('water-trend-loading');
    document.getElementById('water-trend-chart').style.display = 'none';
    document.getElementById('trend-stats-container').style.display = 'none';

    fetch(`/dyn_dt/api/water/parameter_trend?province=${province}&basin=${basin}&station=${station}&month=${month}&parameter=${parameter}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 显示统计信息
          const statsContainer = document.getElementById('trend-stats-container');
          statsContainer.style.display = 'block';

          if (data.statistics && Object.keys(data.statistics).length > 0) {
            document.getElementById('trend-min').textContent = formatNumber(data.statistics.min) + ' ' + data.unit;
            document.getElementById('trend-max').textContent = formatNumber(data.statistics.max) + ' ' + data.unit;
            document.getElementById('trend-avg').textContent = formatNumber(data.statistics.mean) + ' ' + data.unit;
            document.getElementById('trend-std').textContent = formatNumber(data.statistics.std) + ' ' + data.unit;
          } else {
            document.getElementById('trend-min').textContent = '--';
            document.getElementById('trend-max').textContent = '--';
            document.getElementById('trend-avg').textContent = '--';
            document.getElementById('trend-std').textContent = '--';
          }

          // 创建图表
          const ctx = document.getElementById('water-trend-chart').getContext('2d');

          if (waterTrendChart instanceof Chart) {
            waterTrendChart.destroy();
          }

          // 准备数据
          const labels = data.trend.map(item => item.timestamp);
          const values = data.trend.map(item => item.value);

          // 确定图表类型
          const chartType = document.querySelector('.btn-group .btn.active').dataset.chartType || 'line';

          waterTrendChart = new Chart(ctx, {
            type: chartType,
            data: {
              labels: labels,
              datasets: [{
                label: `${parameter} (${data.unit})`,
                data: values,
                backgroundColor: 'rgba(45, 206, 137, 0.2)',
                borderColor: 'rgba(45, 206, 137, 1)',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: 'rgba(45, 206, 137, 1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: {
                duration: 1000,
                easing: 'easeOutQuart'
              },
              scales: {
                x: {
                  type: 'time',
                  time: {
                    unit: 'day',
                    displayFormats: {
                      day: 'MM-dd'
                    }
                  },
                  title: {
                    display: true,
                    text: '监测日期'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: `${parameter} (${data.unit})`
                  }
                }
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  callbacks: {
                    title: function (tooltipItems) {
                      const item = tooltipItems[0];
                      const dateTime = new Date(item.parsed.x);
                      return dateTime.toLocaleString();
                    }
                  }
                }
              }
            }
          });

          // 加载水质类别饼图
          loadWaterQualityPieChart(data.categories);

          // 加载站点状态
          loadStationStatusData(province, basin, station, month);

          // 加载站点对比数据
          loadStationsComparison(province, basin, month, parameter);

          // 加载流域概览
          loadBasinOverview(province, basin, month, parameter);

          // 显示图表
          document.getElementById('water-trend-chart').style.display = 'block';
        }
        hideLoading('water-trend-loading');
      })
      .catch(error => {
        console.error('Error loading water trend data:', error);
        hideLoading('water-trend-loading');
        alert('加载水质趋势数据失败，请重试');
      });
  }

  /**
   * 加载水质类别饼图
   * @param {Object} categories - 水质类别统计
   */
  function loadWaterQualityPieChart(categories) {
    if (waterQualityPieChart instanceof Chart) {
      waterQualityPieChart.destroy();
    }

    const ctx = document.getElementById('water-quality-pie-chart').getContext('2d');

    // 如果没有类别数据，使用默认数据
    if (!categories || Object.keys(categories).length === 0) {
      categories = {
        'Ⅰ': 5,
        'Ⅱ': 15,
        'Ⅲ': 40,
        'Ⅳ': 20,
        'Ⅴ': 15,
        '劣Ⅴ': 5
      };
    }

    const labels = Object.keys(categories);
    const data = Object.values(categories);
    const backgroundColors = labels.map(label => waterQualityColors[label] || getRandomColor());

    waterQualityPieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }

  /**
   * 加载站点状态数据
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   * @param {string} station - 站点名称
   * @param {string} month - 月份
   */
  function loadStationStatusData(province, basin, station, month) {
    fetch(`/dyn_dt/api/water/station_statistics?province=${province}&basin=${basin}&station=${station}&month=${month}`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.station_status) {
          const statusData = data.station_status;
          const total = Object.values(statusData).reduce((acc, val) => acc + val, 0);

          // 正常站点
          const normalCount = statusData['正常'] || 0;
          const normalPercent = total > 0 ? Math.round((normalCount / total) * 100) : 0;

          // 维护站点
          const maintenanceCount = (statusData['维护'] || 0) + (statusData['停站'] || 0) + (statusData['不具备运行条件'] || 0);
          const maintenancePercent = total > 0 ? Math.round((maintenanceCount / total) * 100) : 0;

          // 更新UI
          document.getElementById('normal-status-percent').textContent = `正常: ${normalPercent}%`;
          document.getElementById('normal-status-bar').style.width = `${normalPercent}%`;
          document.getElementById('normal-status-bar').setAttribute('aria-valuenow', normalPercent);

          document.getElementById('maintenance-status-percent').textContent = `维护/停站: ${maintenancePercent}%`;
          document.getElementById('maintenance-status-bar').style.width = `${maintenancePercent}%`;
          document.getElementById('maintenance-status-bar').setAttribute('aria-valuenow', maintenancePercent);
        }
      })
      .catch(error => console.error('Error loading station status data:', error));
  }

  /**
   * 加载站点对比数据
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   * @param {string} month - 月份
   * @param {string} parameter - 参数名称
   */
  function loadStationsComparison(province, basin, month, parameter) {
    showLoading('stations-comparison-loading');
    document.getElementById('stations-comparison-table').style.display = 'none';

    fetch(`/dyn_dt/api/water/basin_overview?province=${province}&basin=${basin}&month=${month}&parameter=${parameter}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const comparisonTbody = document.getElementById('comparison-tbody');
          comparisonTbody.innerHTML = '';

          // 按平均值降序排序
          const sortedData = [...data.data].sort((a, b) => b.mean - a.mean).slice(0, 5);

          sortedData.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${item.station}</td>
              <td>${formatNumber(item.mean)}</td>
              <td>${formatNumber(item.min)}</td>
              <td>${formatNumber(item.max)}</td>
              <td>${formatNumber(item.std)}</td>
            `;
            comparisonTbody.appendChild(tr);
          });

          document.getElementById('stations-comparison-table').style.display = 'block';
        }
        hideLoading('stations-comparison-loading');
      })
      .catch(error => {
        console.error('Error loading stations comparison:', error);
        hideLoading('stations-comparison-loading');
      });
  }

  /**
   * 加载流域概览
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   * @param {string} month - 月份
   * @param {string} parameter - 参数名称
   */
  function loadBasinOverview(province, basin, month, parameter) {
    showLoading('basin-overview-loading');
    document.getElementById('basin-overview-container').style.display = 'none';

    fetch(`/dyn_dt/api/water/basin_overview?province=${province}&basin=${basin}&month=${month}&parameter=${parameter}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (basinOverviewChart instanceof Chart) {
            basinOverviewChart.destroy();
          }

          const ctx = document.getElementById('basin-overview-chart').getContext('2d');

          // 准备数据
          const stations = data.data.map(item => item.station);
          const means = data.data.map(item => item.mean);

          // 限制显示的站点数量
          const maxStations = 8;
          let displayStations = stations;
          let displayMeans = means;

          if (stations.length > maxStations) {
            // 计算截断点
            displayStations = stations.slice(0, maxStations);
            displayMeans = means.slice(0, maxStations);
          }

          basinOverviewChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: displayStations,
              datasets: [{
                label: `平均 ${parameter}`,
                data: displayMeans,
                backgroundColor: displayStations.map((_, i) =>
                  getSafeColorIndex(i, [
                    'rgba(94, 114, 228, 0.7)',
                    'rgba(45, 206, 137, 0.7)',
                    'rgba(251, 99, 64, 0.7)',
                    'rgba(17, 205, 239, 0.7)',
                    'rgba(245, 54, 92, 0.7)',
                    'rgba(137, 101, 224, 0.7)'
                  ])
                ),
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'y',
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `${parameter}: ${formatNumber(context.raw)}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: parameter
                  }
                }
              }
            }
          });

          document.getElementById('basin-overview-container').style.display = 'block';
        }
        hideLoading('basin-overview-loading');
      })
      .catch(error => {
        console.error('Error loading basin overview:', error);
        hideLoading('basin-overview-loading');
      });
  }

  // ============= 上传数据功能 ===============

  /**
   * 初始化上传模态框
   */
  function initializeUploadModal() {
    // 初始化省份下拉菜单
    populateUploadProvinces();

    // 处理省份变更
    document.getElementById('upload-province').addEventListener('change', function () {
      const province = this.value;
      if (province) {
        populateUploadBasins(province);
      } else {
        document.getElementById('upload-basin').innerHTML = '<option value="">请先选择省份</option>';
        document.getElementById('upload-station').innerHTML = '<option value="">请先选择流域</option>';
      }
    });

    // 处理流域变更
    document.getElementById('upload-basin').addEventListener('change', function () {
      const province = document.getElementById('upload-province').value;
      const basin = this.value;
      if (province && basin && basin !== "new_basin") {
        populateUploadStations(province, basin);
      } else {
        document.getElementById('upload-station').innerHTML = '<option value="">请先选择流域</option>';
      }

      // 显示或隐藏新流域输入框
      const newBasinContainer = document.getElementById('new-basin-container');
      if (basin === "new_basin") {
        if (!newBasinContainer) {
          const container = document.createElement('div');
          container.id = 'new-basin-container';
          container.className = 'mb-3';
          container.innerHTML = `
            <label for="new-basin-name" class="form-label">新流域名称</label>
            <input type="text" class="form-control" id="new-basin-name" name="new_basin">
          `;
          this.parentNode.after(container);
        }
      } else if (newBasinContainer) {
        newBasinContainer.remove();
      }
    });

    // 处理新站点链接点击
    document.getElementById('create-new-station').addEventListener('click', function (e) {
      e.preventDefault();
      const container = document.getElementById('new-station-container');
      if (container.style.display === 'none') {
        container.style.display = 'block';
        document.getElementById('upload-station').disabled = true;
      } else {
        container.style.display = 'none';
        document.getElementById('upload-station').disabled = false;
      }
    });

    // 处理提交按钮点击
    document.getElementById('upload-submit-btn').addEventListener('click', uploadWaterData);
  }

  /**
   * 填充上传模态框的省份下拉菜单
   */
  function populateUploadProvinces() {
    fetch('/dyn_dt/api/water/provinces')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const provinceSelect = document.getElementById('upload-province');
          provinceSelect.innerHTML = '<option value="">请选择省份</option>';

          data.provinces.forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            provinceSelect.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error loading provinces for upload:', error));
  }

  /**
   * 填充上传模态框的流域下拉菜单
   * @param {string} province - 省份名称
   */
  function populateUploadBasins(province) {
    fetch(`/dyn_dt/api/water/basins?province=${province}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const basinSelect = document.getElementById('upload-basin');
          basinSelect.innerHTML = '<option value="">请选择流域</option>';

          data.basins.forEach(basin => {
            const option = document.createElement('option');
            option.value = basin;
            option.textContent = basin;
            basinSelect.appendChild(option);
          });

          // 添加创建新流域选项
          const newOption = document.createElement('option');
          newOption.value = "new_basin";
          newOption.textContent = "-- 创建新流域 --";
          basinSelect.appendChild(newOption);
        }
      })
      .catch(error => console.error('Error loading basins for upload:', error));
  }

  /**
   * 填充上传模态框的站点下拉菜单
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   */
  function populateUploadStations(province, basin) {
    fetch(`/dyn_dt/api/water/stations?province=${province}&basin=${basin}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const stationSelect = document.getElementById('upload-station');
          stationSelect.innerHTML = '<option value="">请选择监测站点</option>';

          data.stations.forEach(station => {
            const option = document.createElement('option');
            option.value = station.name;
            option.textContent = station.name;
            stationSelect.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error loading stations for upload:', error));
  }

  /**
   * 上传水质数据
   */
  function uploadWaterData() {
    const form = document.getElementById('uploadDataForm');
    const formData = new FormData(form);

    // 检查是否创建新站点
    if (document.getElementById('new-station-container').style.display !== 'none') {
      const newStationName = document.getElementById('new-station-name').value;
      if (!newStationName) {
        showUploadResult('请输入新站点名称', 'danger');
        return;
      }
      formData.set('station', newStationName);
    }

    // 检查是否创建新流域
    const newBasinContainer = document.getElementById('new-basin-container');
    if (newBasinContainer) {
      const newBasinName = document.getElementById('new-basin-name').value;
      if (!newBasinName) {
        showUploadResult('请输入新流域名称', 'danger');
        return;
      }
      formData.set('basin', newBasinName);
    }

    // 验证表单数据
    const province = formData.get('province');
    const basin = formData.get('basin');
    const station = formData.get('station');
    const month = formData.get('month');
    const file = formData.get('file');

    if (!province || !basin || !station || !month || !file) {
      showUploadResult('请填写所有必要信息并选择文件', 'danger');
      return;
    }

    // 显示进度条
    const progressBar = document.querySelector('#upload-progress .progress-bar');
    document.getElementById('upload-progress').style.display = 'block';
    progressBar.style.width = '0%';

    // 模拟进度（实际进度需要服务器推送事件）
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += 5;
      if (progress > 90) {
        clearInterval(progressInterval);
      }
      progressBar.style.width = `${progress}%`;
    }, 100);

    // 提交数据
    fetch('/dyn_dt/api/water/upload', {
      method: 'POST',
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        if (data.success) {
          showUploadResult(`上传成功！成功导入 ${data.record_count} 条记录。`, 'success');

          // 重置表单并关闭模态框
          setTimeout(() => {
            document.getElementById('uploadDataForm').reset();
            document.getElementById('upload-result').style.display = 'none';
            document.getElementById('upload-progress').style.display = 'none';
            const uploadModalEl = document.getElementById('uploadDataModal');
            if (uploadModalEl) {
              const uploadModal = bootstrap.Modal.getInstance(uploadModalEl);
              if (uploadModal) {
                uploadModal.hide();
              }
            }

            // 刷新数据
            const currentProvince = document.getElementById('province-select').value;
            const currentBasin = document.getElementById('basin-select').value;
            const currentStation = document.getElementById('station-select').value;

            // 如果上传的是当前查看的站点，刷新月份列表
            if (province === currentProvince && basin === currentBasin && station === currentStation) {
              loadAvailableMonths(province, basin, station);
            }
          }, 2000);
        } else {
          showUploadResult(`上传失败: ${data.error}`, 'danger');
        }
      })
      .catch(error => {
        clearInterval(progressInterval);
        console.error('Error uploading data:', error);
        showUploadResult(`上传出错: ${error.message}`, 'danger');
      });
  }

  /**
   * 显示上传结果消息
   * @param {string} message - 消息内容
   * @param {string} type - 消息类型 (success, danger, warning, info)
   */
  function showUploadResult(message, type) {
    const resultDiv = document.getElementById('upload-result');
    resultDiv.className = `alert alert-${type} mt-3`;
    resultDiv.textContent = message;
    resultDiv.style.display = 'block';
  }

  // ============= 导出图表功能 ===============

  /**
   * 将外部图片转换为内联图片（解决跨域问题）
   * @param {string} url - 图片URL
   * @returns {Promise<HTMLImageElement>} - 处理后的图片元素
   */
  function loadImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error(`加载图片失败: ${url}`));
      img.src = url;
    });
  }

  /**
   * 显示导出图表配置模态框
   */
  function showExportChartsModal() {
    const exportModal = new bootstrap.Modal(document.getElementById('exportChartsModal'));
    exportModal.show();
    
    // 设置导出按钮事件
    document.getElementById('export-charts-confirm-btn').onclick = function() {
      const layout = document.getElementById('export-layout').value;
      const format = document.getElementById('export-format').value;
      const quality = parseFloat(document.getElementById('export-quality').value);
      const includeTitle = document.getElementById('export-include-title').checked;
      const includeWatermark = document.getElementById('export-include-watermark').checked;
      
      exportModal.hide();
      exportAllCharts(layout, format, quality, includeTitle, includeWatermark);
    };
  }

/**
 * 导出所有图表合并为一张图
 * @param {string} layout - 布局方式 ('2x2', '1x4', '4x1')
 * @param {string} format - 图片格式 ('png', 'jpeg')
 * @param {number} quality - 图片质量 (0.1-1.0)
 * @param {boolean} includeTitle - 是否包含标题
 * @param {boolean} includeWatermark - 是否包含水印
 */
  function exportAllCharts(layout = '2x2', format = 'png', quality = 0.9, includeTitle = true, includeWatermark = true) {
    // 显示加载指示器
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75';
    loadingDiv.style.zIndex = '9999';
    loadingDiv.innerHTML = '<div class="loading-spinner"></div><div class="ms-3">正在生成图表，请稍候...</div>';
    document.body.appendChild(loadingDiv);
    
    // 给浏览器一点时间来显示加载指示器
    setTimeout(() => {
      try {
        // 获取当前筛选条件
        const province = document.getElementById('province-select').value || '全部';
        const basin = document.getElementById('basin-select').value || '全部';
        const station = document.getElementById('station-select').value || '全部';
        const month = document.getElementById('month-select').value || '全部';
        const parameterBadge = document.querySelector('.parameter-badge.active');
        const parameter = parameterBadge ? parameterBadge.dataset.parameterId || parameterBadge.textContent : '全部';
        const speciesSelected = document.getElementById('speciesSelect').value;
        const parameterSelected = document.getElementById('parameterSelect').value;
        
        // 获取所有需要导出的图表
        const chartsToExport = [
          { 
            canvas: document.getElementById('water-trend-chart'), 
            title: '水质参数趋势',
            description: `监测站点: ${station}, 水质参数: ${parameter}, 监测周期: ${month}`,
            chartInstance: waterTrendChart,
            dataSource: `数据来源: ${province} ${basin} ${station} ${month}`
          },
          { 
            canvas: document.getElementById('fishChart'), 
            title: '鱼类数据分布',
            description: `鱼类: ${speciesMapping[speciesSelected] || speciesSelected}, 参数: ${parameterMapping[parameterSelected] || parameterSelected}`,
            chartInstance: fishChart,
            dataSource: `数据来源: 鱼类生物学特征数据库`
          },
          { 
            canvas: document.getElementById('water-quality-pie-chart'), 
            title: '水质类别统计',
            description: `监测站点: ${station}, 监测周期: ${month}`,
            chartInstance: waterQualityPieChart,
            dataSource: `数据来源: ${province} ${basin} ${station} ${month}`
          },
          { 
            canvas: document.getElementById('basin-overview-chart'), 
            title: '流域水质概览',
            description: `流域: ${basin}, 监测周期: ${month}, 参数: ${parameter}`,
            chartInstance: basinOverviewChart,
            dataSource: `数据来源: ${province} ${basin} ${month}`
          }
        ];
        
        // 筛选出有效的图表（已经渲染的）
        const validCharts = chartsToExport.filter(chart => 
          chart.canvas && 
          chart.canvas.style.display !== 'none' && 
          chart.canvas.width > 0 && 
          chart.canvas.height > 0 &&
          chart.chartInstance // 确保图表实例存在
        );
        
        if (validCharts.length === 0) {
          alert('没有可导出的图表！请确保至少加载了一个图表。');
          document.body.removeChild(loadingDiv);
          return;
        }
        
        // 创建新的画布用于合并图表
        const mergedCanvas = document.createElement('canvas');
        const ctx = mergedCanvas.getContext('2d');
        
        // 计算合并后画布的尺寸和布局
        let chartsPerRow, rows;
        
        if (layout === '1x4') {
          chartsPerRow = 1;
          rows = validCharts.length;
        } else if (layout === '4x1') {
          chartsPerRow = validCharts.length;
          rows = 1;
        } else { // 默认 2x2
          chartsPerRow = Math.min(2, validCharts.length);
          rows = Math.ceil(validCharts.length / chartsPerRow);
        }
        
        // 增加分辨率和尺寸，提高清晰度
        const dpr = window.devicePixelRatio || 1;
        const chartWidth = 800;
        const chartHeight = 500;
        const padding = 60;
        const titleHeight = 40; // 图表标题高度
        const descHeight = 25; // 图表描述高度
        const sourceHeight = 20; // 数据源信息高度
        const headerHeight = includeTitle ? 180 : 40; // 关键修改：增加顶部区域高度，确保有足够空间
        const footerHeight = 80; // 页脚高度
        const chartPadding = 20; // 图表内部填充
        
        // 设置合并画布的尺寸
        const canvasWidth = chartsPerRow * chartWidth + (chartsPerRow + 1) * padding;
        const canvasHeight = headerHeight + rows * (chartHeight + titleHeight + descHeight + sourceHeight + padding) + footerHeight;
        
        mergedCanvas.width = canvasWidth * dpr;
        mergedCanvas.height = canvasHeight * dpr;
        mergedCanvas.style.width = `${canvasWidth}px`;
        mergedCanvas.style.height = `${canvasHeight}px`;
        
        // 缩放以适应高DPI
        ctx.scale(dpr, dpr);
        
        // 填充白色背景
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        
        // 添加标题和日期
        if (includeTitle) {
          // 添加标题背景 - 扩展标题区域的高度
          ctx.fillStyle = '#f8f9fa';
          ctx.fillRect(0, 0, canvasWidth, headerHeight);
          
          // 添加标题边框
          ctx.strokeStyle = '#e9ecef';
          ctx.lineWidth = 1;
          ctx.strokeRect(0, 0, canvasWidth, headerHeight);
          
          // 添加主标题
          ctx.fillStyle = '#5e72e4';
          ctx.font = 'bold 32px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('水产养殖数据监控平台 - 图表汇总', canvasWidth / 2, padding);
          
          // 添加当前日期和筛选条件 - 使用多行显示，确保信息完整
          ctx.fillStyle = '#525f7f';
          ctx.font = 'bold 18px Arial';
          const today = new Date().toLocaleDateString();
          ctx.fillText(`导出日期: ${today}`, canvasWidth / 2, padding + 35);
          
          // 使用更清晰的布局显示筛选条件
          ctx.font = 'bold 16px Arial';
          ctx.fillText(`省份: ${province}`, canvasWidth / 2, padding + 65);
          ctx.fillText(`流域: ${basin}`, canvasWidth / 2, padding + 90);
          ctx.fillText(`站点: ${station} | 月份: ${month} | 参数: ${parameter}`, canvasWidth / 2, padding + 110);
          
          // 绘制分隔线 - 位置调整到标题区域底部
          ctx.strokeStyle = '#e9ecef';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(padding, headerHeight - 5);
          ctx.lineTo(canvasWidth - padding, headerHeight - 5);
          ctx.stroke();
        }
        
        // 为每个图表创建临时画布，以保留图例等信息
        for (let i = 0; i < validCharts.length; i++) {
          const chart = validCharts[i];
          const chartInstance = chart.chartInstance;
          
          // 计算位置 - 确保图表位置在标题区域下方
          const row = Math.floor(i / chartsPerRow);
          const col = i % chartsPerRow;
          
          const x = col * (chartWidth + padding) + padding;
          const y = headerHeight + row * (chartHeight + titleHeight + descHeight + sourceHeight + padding);
          
          // 绘制图表区域背景和边框
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(x - padding/2, y, 
                      chartWidth + padding, chartHeight + titleHeight + descHeight + sourceHeight);
          ctx.strokeStyle = '#e9ecef';
          ctx.lineWidth = 1;
          ctx.strokeRect(x - padding/2, y, 
                        chartWidth + padding, chartHeight + titleHeight + descHeight + sourceHeight);
          
          // 绘制图表标题
          ctx.fillStyle = '#344767';
          ctx.font = 'bold 22px Arial';
          ctx.textAlign = 'left';
          ctx.fillText(chart.title, x, y + 25);
          
          // 绘制图表描述
          if (chart.description) {
            ctx.fillStyle = '#5e72e4';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(chart.description, x, y + titleHeight + 15);
          }
          
          // 创建临时画布用于绘制图表（包括图例）
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = chartWidth;
          tempCanvas.height = chartHeight;
          const tempCtx = tempCanvas.getContext('2d');
          
          // 获取图表配置
          let chartData, chartOptions;
          if (chartInstance) {
            chartData = chartInstance.data;
            chartOptions = { ...chartInstance.options }; // 创建深拷贝避免修改原始配置
            
            // 根据图表类型设置特定选项
            if (chartInstance.config.type === 'pie' || chartInstance.config.type === 'doughnut') {
              // 确保饼图图例可见
              chartOptions.plugins = {
                ...chartOptions.plugins,
                legend: {
                  display: true,
                  position: 'right',
                  labels: {
                    font: {
                      size: 14,
                      weight: 'bold'
                    }
                  }
                },
                title: {
                  display: false // 我们已经手动绘制标题
                }
              };
            } else {
              // 确保折线图/柱状图图例和坐标轴可见
              chartOptions.plugins = {
                ...chartOptions.plugins,
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    font: {
                      size: 14,
                      weight: 'bold'
                    },
                    padding: 15
                  }
                },
                title: {
                  display: false // 我们已经手动绘制标题
                }
              };
              
              // 确保坐标轴标签清晰可见
              chartOptions.scales = {
                ...chartOptions.scales,
                x: {
                  ...chartOptions.scales?.x,
                  display: true,
                  grid: {
                    display: true,
                    color: 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    font: {
                      size: 12,
                      weight: 'bold'
                    },
                    color: '#344767'
                  },
                  title: {
                    display: true,
                    text: chartOptions.scales?.x?.title?.text || '',
                    font: {
                      size: 14,
                      weight: 'bold'
                    },
                    color: '#344767'
                  }
                },
                y: {
                  ...chartOptions.scales?.y,
                  display: true,
                  grid: {
                    display: true,
                    color: 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    font: {
                      size: 12,
                      weight: 'bold'
                    },
                    color: '#344767'
                  },
                  title: {
                    display: true,
                    text: chartOptions.scales?.y?.title?.text || '',
                    font: {
                      size: 14,
                      weight: 'bold'
                    },
                    color: '#344767'
                  }
                }
              };
            }
            
            // 添加内部填充
            chartOptions.layout = {
              padding: {
                top: chartPadding,
                right: chartPadding,
                bottom: chartPadding,
                left: chartPadding
              }
            };
            
            // 临时创建新的Chart实例绘制到临时画布
            new Chart(tempCtx, {
              type: chartInstance.config.type,
              data: chartData,
              options: {
                ...chartOptions,
                animation: false,
                responsive: false,
                maintainAspectRatio: false
              }
            });
            
            // 绘制临时画布到合并画布 - 调整位置确保不会遮挡标题
            ctx.drawImage(tempCanvas, x, y + titleHeight + descHeight + 10, chartWidth, chartHeight);
            
            // 添加数据源信息
            if (chart.dataSource) {
              ctx.fillStyle = '#8392ab';
              ctx.font = 'italic 14px Arial';
              ctx.textAlign = 'left';
              ctx.fillText(chart.dataSource, x, y + titleHeight + descHeight + chartHeight + 30);
            }
          } else {
            // 如果没有图表实例，直接绘制原始画布
            ctx.drawImage(chart.canvas, x, y + titleHeight + descHeight + 10, chartWidth, chartHeight);
          }
        }
        
        // 添加水印和页脚
        if (includeWatermark) {
          // 添加页脚背景
          ctx.fillStyle = '#f8f9fa';
          ctx.fillRect(0, canvasHeight - footerHeight, canvasWidth, footerHeight);
          
          // 添加页脚边框
          ctx.strokeStyle = '#e9ecef';
          ctx.lineWidth = 1;
          ctx.strokeRect(0, canvasHeight - footerHeight, canvasWidth, footerHeight);
          
          // 添加水印文本
          ctx.fillStyle = 'rgba(94, 114, 228, 0.2)';
          ctx.font = 'italic 20px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('水产养殖数据监控平台 - 仅供内部使用', canvasWidth / 2, canvasHeight - footerHeight/2);
          
          // 添加导出时间和详细信息
          const exportTime = new Date().toLocaleString();
          ctx.fillStyle = '#344767';
          ctx.font = '14px Arial';
          ctx.textAlign = 'left';
          ctx.fillText(`导出时间: ${exportTime}`, padding, canvasHeight - footerHeight/2 + 20);
          
          // 添加版权信息
          ctx.textAlign = 'right';
          ctx.fillText('版权所有 © ' + new Date().getFullYear() + ' 水产养殖数据监控平台', canvasWidth - padding, canvasHeight - footerHeight/2 + 20);
        }
        
        // 转换为图片并下载
        const dataUrl = mergedCanvas.toDataURL(`image/${format}`, format === 'jpeg' ? quality : undefined);
        const downloadLink = document.createElement('a');
        downloadLink.href = dataUrl;
        
        // 生成文件名
        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const timeStr = new Date().toTimeString().slice(0, 8).replace(/:/g, '');
        let filename = `水质监测数据图表_${province}_${basin}_${station}_${month}`;
        filename = filename.replace(/全部/g, 'ALL'); // 替换"全部"为"ALL"
        downloadLink.download = `${filename}_${dateStr}_${timeStr}.${format}`;
        
        // 触发下载
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // 移除加载指示器
        document.body.removeChild(loadingDiv);
      } catch (error) {
        console.error('导出图表时出错:', error);
        alert('导出图表时出错: ' + error.message);
        document.body.removeChild(loadingDiv);
      }
    }, 100);
  }

  // ============= 导出数据功能 ===============

  /**
   * 初始化导出模态框
   */
  function initializeExportModal() {
    // 初始化省份下拉菜单
    populateExportProvinces();

    // 处理省份变更
    document.getElementById('export-province').addEventListener('change', function () {
      const province = this.value;
      if (province) {
        populateExportBasins(province);
      } else {
        document.getElementById('export-basin').innerHTML = '<option value="">请先选择省份</option>';
        document.getElementById('export-station').innerHTML = '<option value="">请先选择流域</option>';
        document.getElementById('export-month').innerHTML = '<option value="">请先选择监测站点</option>';
      }
    });

    // 处理流域变更
    document.getElementById('export-basin').addEventListener('change', function () {
      const province = document.getElementById('export-province').value;
      const basin = this.value;
      if (province && basin) {
        populateExportStations(province, basin);
      } else {
        document.getElementById('export-station').innerHTML = '<option value="">请先选择流域</option>';
        document.getElementById('export-month').innerHTML = '<option value="">请先选择监测站点</option>';
      }
    });

    // 处理站点变更
    document.getElementById('export-station').addEventListener('change', function () {
      const province = document.getElementById('export-province').value;
      const basin = document.getElementById('export-basin').value;
      const station = this.value;
      if (province && basin && station) {
        populateExportMonths(province, basin, station);
      } else {
        document.getElementById('export-month').innerHTML = '<option value="">请先选择监测站点</option>';
      }
    });

    // 处理导出按钮点击
    document.getElementById('export-submit-btn').addEventListener('click', exportWaterData);
  }

  /**
   * 填充导出模态框的省份下拉菜单
   */
  function populateExportProvinces() {
    fetch('/dyn_dt/api/water/provinces')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const provinceSelect = document.getElementById('export-province');
          provinceSelect.innerHTML = '<option value="">请选择省份</option>';

          data.provinces.forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            provinceSelect.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error loading provinces for export:', error));
  }

  /**
   * 填充导出模态框的流域下拉菜单
   * @param {string} province - 省份名称
   */
  function populateExportBasins(province) {
    fetch(`/dyn_dt/api/water/basins?province=${province}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const basinSelect = document.getElementById('export-basin');
          basinSelect.innerHTML = '<option value="">请选择流域</option>';

          data.basins.forEach(basin => {
            const option = document.createElement('option');
            option.value = basin;
            option.textContent = basin;
            basinSelect.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error loading basins for export:', error));
  }

  /**
   * 填充导出模态框的站点下拉菜单
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   */
  function populateExportStations(province, basin) {
    fetch(`/dyn_dt/api/water/stations?province=${province}&basin=${basin}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const stationSelect = document.getElementById('export-station');
          stationSelect.innerHTML = '<option value="">请选择监测站点</option>';

          data.stations.forEach(station => {
            const option = document.createElement('option');
            option.value = station.name;
            option.textContent = station.name;
            stationSelect.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error loading stations for export:', error));
  }

  /**
   * 填充导出模态框的月份下拉菜单
   * @param {string} province - 省份名称
   * @param {string} basin - 流域名称
   * @param {string} station - 站点名称
   */
  function populateExportMonths(province, basin, station) {
    fetch(`/dyn_dt/api/water/available_months?province=${province}&basin=${basin}&station=${station}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const monthSelect = document.getElementById('export-month');
          monthSelect.innerHTML = '<option value="">请选择月份</option>';

          data.available_months.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            monthSelect.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error loading months for export:', error));
  }

  /**
   * 导出水质数据
   */
  function exportWaterData() {
    const province = document.getElementById('export-province').value;
    const basin = document.getElementById('export-basin').value;
    const station = document.getElementById('export-station').value;
    const month = document.getElementById('export-month').value;
    
    if (!province || !basin || !station || !month) {
      alert('请选择完整的导出信息');
      return;
    }
    
    // 创建下载URL
    const downloadUrl = `/dyn_dt/export/${station}?province=${encodeURIComponent(province)}&basin=${encodeURIComponent(basin)}&station=${encodeURIComponent(station)}&month=${encodeURIComponent(month)}`;
    
    // 创建临时链接并触发下载
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = `${station}_${month}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // 关闭模态框
    const exportModalEl = document.getElementById('exportDataModal');
    if (exportModalEl) {
      const exportModal = bootstrap.Modal.getInstance(exportModalEl);
      if (exportModal) {
        exportModal.hide();
      }
    }
  }

  // ============= 事件监听 ===============

  document.addEventListener('DOMContentLoaded', function () {
    // 初始化鱼类数据
    document.getElementById("loadDataBtn").addEventListener("click", loadFishDistribution);

    // 初始化省份下拉菜单
    loadProvinces();

    // 初始化鱼类统计数据
    loadFishStats();

    // 初始化Bootstrap模态框
    let uploadModal = null;
    let exportModal = null;

    // 检查是否存在模态框元素
    const uploadModalEl = document.getElementById('uploadDataModal');
    const exportModalEl = document.getElementById('exportDataModal');

    if (uploadModalEl) {
      uploadModal = new bootstrap.Modal(uploadModalEl);
      // 初始化上传模态框
      initializeUploadModal();
    }

    if (exportModalEl) {
      exportModal = new bootstrap.Modal(exportModalEl);
      // 初始化导出模态框
      initializeExportModal();
    }

    // 上传和导出按钮事件
    const uploadBtn = document.getElementById('upload-data-btn');
    if (uploadBtn && uploadModal) {
      uploadBtn.addEventListener('click', function () {
        populateUploadProvinces(); // 加载省份数据
        uploadModal.show();
      });
    }

    const exportBtn = document.getElementById('export-data-btn');
    if (exportBtn && exportModal) {
      exportBtn.addEventListener('click', function () {
        populateExportProvinces(); // 加载省份数据
        exportModal.show();
      });
    }

    // 导出图表按钮事件
    const exportChartsBtn = document.getElementById('export-charts-btn');
    if (exportChartsBtn) {
      exportChartsBtn.addEventListener('click', showExportChartsModal);
    }

    // 省份变更事件
    document.getElementById('province-select').addEventListener('change', function () {
      const province = this.value;
      if (province) {
        loadBasins(province);
      } else {
        document.getElementById('basin-select').innerHTML = '<option value="">请先选择省份</option>';
      }
      document.getElementById('station-select').innerHTML = '<option value="">请先选择流域</option>';
      document.getElementById('month-select').innerHTML = '<option value="">请先选择监测站点</option>';
    });

    // 流域变更事件
    document.getElementById('basin-select').addEventListener('change', function () {
      const province = document.getElementById('province-select').value;
      const basin = this.value;
      if (province && basin) {
        loadStations(province, basin);
      } else {
        document.getElementById('station-select').innerHTML = '<option value="">请先选择流域</option>';
      }
      document.getElementById('month-select').innerHTML = '<option value="">请先选择监测站点</option>';
    });

    // 站点变更事件
    document.getElementById('station-select').addEventListener('change', function () {
      const province = document.getElementById('province-select').value;
      const basin = document.getElementById('basin-select').value;
      const station = this.value;
      if (province && basin && station) {
        loadAvailableMonths(province, basin, station);
      } else {
        document.getElementById('month-select').innerHTML = '<option value="">请先选择监测站点</option>';
      }
    });

    // 加载水质数据按钮事件
    document.getElementById('load-water-data').addEventListener('click', loadWaterTrendData);

    // 图表类型切换事件
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // 重新加载趋势图
        const province = document.getElementById('province-select').value;
        const basin = document.getElementById('basin-select').value;
        const station = document.getElementById('station-select').value;
        const month = document.getElementById('month-select').value;

        if (province && basin && station && month) {
          loadWaterTrendData();
        }
      });
    });

    // 默认加载鱼类数据
    loadFishDistribution();
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock javascripts %}
{% extends "layouts/base.html" %}

{% block title %} 智能海洋牧场数据中心 {% endblock %}

{% block stylesheets %}
<link href="{{ url_for('static', filename='assets/css/data-analysis.css') }}" rel="stylesheet" />
<style>
/* 报警与通知模块样式 */
.alert-card {
    border-left: 4px solid #dc3545;
    transition: all 0.3s ease;
}

.alert-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.15);
}

.alert-normal {
    border-left-color: #28a745;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-danger {
    border-left-color: #dc3545;
}

.alert-critical {
    border-left-color: #6f42c1;
}

.alert-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    animation: pulse 2s infinite;
}

.alert-indicator.normal { background-color: #28a745; }
.alert-indicator.warning { background-color: #ffc107; }
.alert-indicator.danger { background-color: #dc3545; }
.alert-indicator.critical { background-color: #6f42c1; }

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.notification-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 4px solid #e9ecef;
    background-color:rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.notification-item:hover {
    background-color: #e9ecef;
}

.notification-item.unread {
    background-color: #fff3cd;
    border-left-color: #ffc107;
}

.notification-item.critical {
    background-color: #f8d7da;
    border-left-color: #dc3545;
}

.parameter-threshold {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
}

.parameter-threshold:hover {
    background-color: #e9ecef;
}

.threshold-input {
    max-width: 120px;
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
}

.real-time-monitor {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.monitor-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
}

.monitor-unit {
    font-size: 0.875rem;
    opacity: 0.8;
}

.alert-settings-panel {
    background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
    border-radius: 12px;
    padding: 22px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: none;
    color: white;
}

.settings-toggle {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.settings-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

/* 通知展开/收起功能样式 */
.notification-container {
    max-height: 300px;
    overflow-y: auto;
    transition: max-height 0.3s ease, opacity 0.3s ease;
}

.notification-container.collapsed {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    margin: 0;
    padding: 0;
}

/* 移除渐变效果，因为现在我们完全隐藏内容 */
.notification-container.collapsed:after {
    display: none;
}

/* 添加一个空状态提示 */
.notification-empty-state {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    display: none;
}

.notification-container.collapsed + .notification-empty-state {
    display: block;
}



input:checked + .slider {
    background-color: #2196F3;
}

input:checked + .slider:before {
    transform: translateX(26px);
}
</style>
{% endblock stylesheets %}

{% block content %}
<div class="min-height-300 bg-primary position-absolute w-100"></div>

{% include "includes/sidenav.html" %}

<main class="main-content position-relative border-radius-lg">
    {% include "includes/navigation.html" %}

    <div class="container-fluid py-4">
        <!-- 搜索部分 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header pb-0">
                        <h6>智能海洋牧场数据中心</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <div class="search-container d-flex">
                                    <div class="flex-grow-1 me-2">
                                        <input type="text" class="form-control" id="searchInput" placeholder="输入设备ID、参数名或关键词...">
                                    </div>
                                    <button class="btn btn-primary" type="button" id="searchButton">
                                        <i class="fas fa-search"></i> 搜索
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 报警与通知模块 -->
        <div class="row mb-4">
            <!-- 实时监控面板 -->
            <div class="col-lg-8 mb-4">
                <div class="card alert-card">
                    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            实时监控与报警
                        </h6>
                        <div class="d-flex align-items-center">
                            <span class="alert-indicator normal me-2"></span>
                            <span class="text-sm">系统正常</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="real-time-monitor">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="monitor-item">
                                        <i class="fas fa-thermometer-half fa-2x mb-2"></i>
                                        <div class="monitor-value" id="temp-value">24.5</div>
                                        <div class="monitor-unit">°C</div>
                                        <div class="text-sm">水温</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="monitor-item">
                                        <i class="fas fa-wind fa-2x mb-2"></i>
                                        <div class="monitor-value" id="oxygen-value">7.2</div>
                                        <div class="monitor-unit">mg/L</div>
                                        <div class="text-sm">溶解氧</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="monitor-item">
                                        <i class="fas fa-flask fa-2x mb-2"></i>
                                        <div class="monitor-value" id="ph-value">7.8</div>
                                        <div class="monitor-unit">pH</div>
                                        <div class="text-sm">酸碱度</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="monitor-item">
                                        <i class="fas fa-tint fa-2x mb-2"></i>
                                        <div class="monitor-value" id="turbidity-value">2.1</div>
                                        <div class="monitor-unit">NTU</div>
                                        <div class="text-sm">浊度</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 当前报警状态 -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-uppercase text-muted text-sm font-weight-bolder mb-3">当前报警状态</h6>
                                <div id="current-alerts">
                                    <!-- 动态加载报警信息 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 报警设置面板 -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header pb-0">
                        <h6 class="mb-0">
                            <i class="fas fa-cog text-primary me-2"></i>
                            报警设置
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert-settings-panel">
                            <!-- 全局开关 -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-sm font-weight-bold">报警系统</span>
                                <label class="settings-toggle">
                                    <input type="checkbox" id="alert-system-toggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <!-- 参数阈值设置 -->
                            <h6 class="text-uppercase text-muted text-sm font-weight-bolder mb-3">参数阈值设置</h6>
                            
                            <!-- 水温阈值 -->
                            <div class="parameter-threshold">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-sm font-weight-bold">水温 (°C)</span>
                                    <span class="status-badge bg-success">正常</span>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最小值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="temp-min" value="18" step="0.1">
                                    </div>
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最大值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="temp-max" value="30" step="0.1">
                                    </div>
                                </div>
                            </div>

                            <!-- 溶解氧阈值 -->
                            <div class="parameter-threshold">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-sm font-weight-bold">溶解氧 (mg/L)</span>
                                    <span class="status-badge bg-success">正常</span>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最小值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="oxygen-min" value="5.0" step="0.1">
                                    </div>
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最大值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="oxygen-max" value="12.0" step="0.1">
                                    </div>
                                </div>
                            </div>

                            <!-- pH阈值 -->
                            <div class="parameter-threshold">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-sm font-weight-bold">pH值</span>
                                    <span class="status-badge bg-success">正常</span>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最小值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="ph-min" value="6.5" step="0.1">
                                    </div>
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最大值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="ph-max" value="8.5" step="0.1">
                                    </div>
                                </div>
                            </div>

                            <!-- 浊度阈值 -->
                            <div class="parameter-threshold">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-sm font-weight-bold">浊度 (NTU)</span>
                                    <span class="status-badge bg-success">正常</span>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最小值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="turbidity-min" value="0" step="0.1">
                                    </div>
                                    <div class="col-6">
                                        <label class="text-xs text-muted">最大值</label>
                                        <input type="number" class="form-control form-control-sm threshold-input" id="turbidity-max" value="5.0" step="0.1">
                                    </div>
                                </div>
                            </div>

                            <!-- 保存设置按钮 -->
                            <button class="btn btn-primary btn-sm w-100 mt-3" id="save-settings">
                                <i class="fas fa-save me-2"></i>保存设置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 通知历史 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-bell text-info me-2"></i>
                            通知历史
                        </h6>
                        <div class="d-flex align-items-center">
                            <div class="btn-group btn-group-sm me-3">
                                <button type="button" class="btn btn-outline-primary active" data-filter="all">全部</button>
                                <button type="button" class="btn btn-outline-warning" data-filter="warning">警告</button>
                                <button type="button" class="btn btn-outline-danger" data-filter="danger">危险</button>
                                <button type="button" class="btn btn-outline-secondary" data-filter="info">信息</button>
                            </div>
                            <button id="toggleNotifications" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-chevron-down"></i> 展开
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="notification-history" class="notification-container collapsed">
                            <!-- 动态加载通知历史 -->
                        </div>
                        <div class="notification-empty-state">
                            <i class="fas fa-bell-slash fa-2x mb-3"></i>
                            <p>通知已收起，点击"展开"按钮查看通知历史</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Analysis Dashboard -->
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="stat-box primary text-center">
                            <i class="fas fa-server"></i>
                            <div class="stat-number">18/20</div>
                            <div>设备在线率</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="stat-box success text-center">
                            <i class="fas fa-fish"></i>
                            <div class="stat-number">12,547</div>
                            <div>当前养殖数量</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="stat-box warning text-center">
                            <i class="fas fa-bolt"></i>
                            <div class="stat-number">87.6 kW</div>
                            <div>系统耗电量</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="stat-box info text-center">
                            <i class="fas fa-tachometer-alt"></i>
                            <div class="stat-number">99.8%</div>
                            <div>系统稳定性</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要内容区 -->
        <div class="row">
            <!-- 左侧：系统状态与设备监控 -->
            <div class="col-lg-8">
                <!-- 系统运行状态 -->
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6>系统运行状态</h6>
                    </div>
                    <div class="card-body">
                        <div id="systemStatusChart" style="height: 300px;"></div>
                    </div>
                </div>

                <!-- 设备状态概览 -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card system-card">
                            <div class="card-header pb-0">
                                <h6>设备状态概览</h6>
                            </div>
                            <div class="card-body">
                                <div class="gauges-container">
                                    <div>
                                        <div id="cpuGauge" class="gauge-chart"></div>
                                        <div class="text-center">CPU使用率</div>
                                    </div>
                                    <div>
                                        <div id="memoryGauge" class="gauge-chart"></div>
                                        <div class="text-center">内存使用率</div>
                                    </div>
                                    <div>
                                        <div id="diskGauge" class="gauge-chart"></div>
                                        <div class="text-center">存储使用率</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card system-card">
                            <div class="card-header pb-0">
                                <h6>网络流量</h6>
                            </div>
                            <div class="card-body">
                                <div id="networkTrafficChart" style="height: 200px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设备分布地图 -->
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6>设备分布地图</h6>
                    </div>
                    <div class="card-body">
                        <div id="deviceMapChart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>

            <!-- 右侧：设备列表、天气、水质 -->
            <div class="col-lg-4">
                <!-- 天气信息 -->
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6>当前海域天气</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="weather-info">
                                    <div class="weather-icon">
                                        <i class="fas fa-sun"></i>
                                    </div>
                                    <div class="weather-temp">28°C</div>
                                    <div>晴朗</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                        <div><i class="fas fa-wind me-2"></i> 风速</div>
                                        <div>15 km/h</div>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                        <div><i class="fas fa-compass me-2"></i> 风向</div>
                                        <div>东北</div>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                        <div><i class="fas fa-tint me-2"></i> 湿度</div>
                                        <div>65%</div>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                        <div><i class="fas fa-water me-2"></i> 浪高</div>
                                        <div>0.8m</div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设备状态列表 -->
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6>关键设备状态</h6>
                    </div>
                    <div class="card-body">
                        <div class="device-status active-device">
                            <div class="fw-bold">自动投饵系统 <span class="badge bg-success rounded-pill">运行中</span></div>
                            <div class="text-sm text-muted">设备ID: FEED-001 | 上次维护: 3天前</div>
                        </div>
                        <div class="device-status active-device">
                            <div class="fw-bold">水质监测系统 <span class="badge bg-success rounded-pill">运行中</span></div>
                            <div class="text-sm text-muted">设备ID: WQ-005 | 上次维护: 7天前</div>
                        </div>
                        <div class="device-status warning-device">
                            <div class="fw-bold">氧气供应系统 <span class="badge bg-warning rounded-pill">需维护</span></div>
                            <div class="text-sm text-muted">设备ID: OXY-002 | 上次维护: 35天前</div>
                        </div>
                        <div class="device-status active-device">
                            <div class="fw-bold">水下摄像头 <span class="badge bg-success rounded-pill">运行中</span></div>
                            <div class="text-sm text-muted">设备ID: CAM-008 | 上次维护: 14天前</div>
                        </div>
                        <div class="device-status inactive-device">
                            <div class="fw-bold">备用发电机 <span class="badge bg-secondary rounded-pill">待机</span></div>
                            <div class="text-sm text-muted">设备ID: GEN-003 | 上次测试: 8天前</div>
                        </div>
                    </div>
                </div>

                <!-- 系统通知 -->
                <div class="card mb-4">
                    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">系统通知</h6>
                        <span class="badge bg-primary rounded-pill">5 条新消息</span>
                    </div>
                    <div class="card-body">
                        <div class="notification-item">
                            <div class="notification-icon warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="notification-content">
                                <h6>氧气供应系统需要维护</h6>
                                <p>30分钟前</p>
                            </div>
                        </div>
                        <div class="notification-item">
                            <div class="notification-icon success">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="notification-content">
                                <h6>完成今日的自动投饵任务</h6>
                                <p>2小时前</p>
                            </div>
                        </div>
                        <div class="notification-item">
                            <div class="notification-icon info">
                                <i class="fas fa-sync"></i>
                            </div>
                            <div class="notification-content">
                                <h6>系统软件已更新至v2.5.3</h6>
                                <p>5小时前</p>
                            </div>
                        </div>
                        <div class="notification-item">
                            <div class="notification-icon warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="notification-content">
                                <h6>检测到水温略有异常</h6>
                                <p>昨天</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 水质和环境数据 -->
        <div class="row">
            <!-- 水质参数监测 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header pb-0">
                        <h6>水质参数监测</h6>
                    </div>
                    <div class="card-body">
                        <div id="waterQualityChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- 养殖鱼群健康状况 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header pb-0">
                        <h6>养殖鱼群健康状况</h6>
                    </div>
                    <div class="card-body">
                        <div id="fishHealthChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 能源消耗和维护日历 -->
        <div class="row">
            <!-- 能源消耗 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header pb-0">
                        <h6>能源消耗</h6>
                    </div>
                    <div class="card-body">
                        <div id="energyConsumptionChart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>

            <!-- 维护日历 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header pb-0">
                        <h6>设备维护日历</h6>
                    </div>
                    <div class="card-body">
                        <div id="maintenanceCalendar" class="calendar-heatmap"></div>
                        <div class="mt-3">
                            <div class="fw-bold">即将到期的维护:</div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                    <div>氧气供应系统 (OXY-002)</div>
                                    <span class="badge bg-danger">今天</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                    <div>水质过滤系统 (FILT-006)</div>
                                    <span class="badge bg-warning">3天后</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                    <div>中央控制系统 (CTRL-001)</div>
                                    <span class="badge bg-info">7天后</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// 报警与通知模块功能
class AlertNotificationSystem {
    constructor() {
        this.alertSettings = {
            enabled: true,
            thresholds: {
                temperature: { min: 18, max: 30 },
                oxygen: { min: 5.0, max: 12.0 },
                ph: { min: 6.5, max: 8.5 },
                turbidity: { min: 0, max: 5.0 }
            }
        };
        this.currentAlerts = [];
        this.notificationHistory = [];
        this.monitoringInterval = null;
        this.init();
    }

    init() {
        this.loadSettings();
        this.startMonitoring();
        this.loadNotificationHistory();
        this.bindEvents();
    }

    loadSettings() {
        const savedSettings = localStorage.getItem('alertSettings');
        if (savedSettings) {
            this.alertSettings = JSON.parse(savedSettings);
        }
        this.updateSettingsUI();
    }

    saveSettings() {
        // 从UI获取设置
        this.alertSettings.enabled = document.getElementById('alert-system-toggle').checked;
        this.alertSettings.thresholds.temperature.min = parseFloat(document.getElementById('temp-min').value);
        this.alertSettings.thresholds.temperature.max = parseFloat(document.getElementById('temp-max').value);
        this.alertSettings.thresholds.oxygen.min = parseFloat(document.getElementById('oxygen-min').value);
        this.alertSettings.thresholds.oxygen.max = parseFloat(document.getElementById('oxygen-max').value);
        this.alertSettings.thresholds.ph.min = parseFloat(document.getElementById('ph-min').value);
        this.alertSettings.thresholds.ph.max = parseFloat(document.getElementById('ph-max').value);
        this.alertSettings.thresholds.turbidity.min = parseFloat(document.getElementById('turbidity-min').value);
        this.alertSettings.thresholds.turbidity.max = parseFloat(document.getElementById('turbidity-max').value);

        localStorage.setItem('alertSettings', JSON.stringify(this.alertSettings));
        this.showNotification('设置已保存', 'success');
    }

    updateSettingsUI() {
        document.getElementById('alert-system-toggle').checked = this.alertSettings.enabled;
        document.getElementById('temp-min').value = this.alertSettings.thresholds.temperature.min;
        document.getElementById('temp-max').value = this.alertSettings.thresholds.temperature.max;
        document.getElementById('oxygen-min').value = this.alertSettings.thresholds.oxygen.min;
        document.getElementById('oxygen-max').value = this.alertSettings.thresholds.oxygen.max;
        document.getElementById('ph-min').value = this.alertSettings.thresholds.ph.min;
        document.getElementById('ph-max').value = this.alertSettings.thresholds.ph.max;
        document.getElementById('turbidity-min').value = this.alertSettings.thresholds.turbidity.min;
        document.getElementById('turbidity-max').value = this.alertSettings.thresholds.turbidity.max;
    }

    startMonitoring() {
        if (this.monitoringInterval) {
            clearInterval(this.monitoringInterval);
        }

        this.monitoringInterval = setInterval(() => {
            this.updateRealTimeData();
            this.checkAlerts();
        }, 5000); // 每5秒更新一次
    }

    updateRealTimeData() {
        // 模拟实时数据更新
        const tempValue = 20 + Math.random() * 15; // 20-35°C
        const oxygenValue = 4 + Math.random() * 8; // 4-12 mg/L
        const phValue = 6 + Math.random() * 3; // 6-9 pH
        const turbidityValue = Math.random() * 6; // 0-6 NTU

        document.getElementById('temp-value').textContent = tempValue.toFixed(1);
        document.getElementById('oxygen-value').textContent = oxygenValue.toFixed(1);
        document.getElementById('ph-value').textContent = phValue.toFixed(1);
        document.getElementById('turbidity-value').textContent = turbidityValue.toFixed(1);

        // 检查是否触发报警
        this.checkParameterAlert('temperature', tempValue);
        this.checkParameterAlert('oxygen', oxygenValue);
        this.checkParameterAlert('ph', phValue);
        this.checkParameterAlert('turbidity', turbidityValue);
    }

    checkParameterAlert(parameter, value) {
        const threshold = this.alertSettings.thresholds[parameter];
        let alertLevel = 'normal';
        let message = '';

        if (value < threshold.min) {
            alertLevel = value < threshold.min * 0.8 ? 'critical' : 'warning';
            message = `${this.getParameterName(parameter)}过低: ${value}${this.getParameterUnit(parameter)}`;
        } else if (value > threshold.max) {
            alertLevel = value > threshold.max * 1.2 ? 'critical' : 'warning';
            message = `${this.getParameterName(parameter)}过高: ${value}${this.getParameterUnit(parameter)}`;
        }

        if (alertLevel !== 'normal') {
            this.triggerAlert(parameter, alertLevel, message, value);
        }

        // 更新参数状态显示
        this.updateParameterStatus(parameter, alertLevel);
    }

    getParameterName(parameter) {
        const names = {
            temperature: '水温',
            oxygen: '溶解氧',
            ph: 'pH值',
            turbidity: '浊度'
        };
        return names[parameter] || parameter;
    }

    getParameterUnit(parameter) {
        const units = {
            temperature: '°C',
            oxygen: ' mg/L',
            ph: '',
            turbidity: ' NTU'
        };
        return units[parameter] || '';
    }

    updateParameterStatus(parameter, status) {
        const statusElement = document.querySelector(`#${parameter}-min`).closest('.parameter-threshold').querySelector('.status-badge');
        statusElement.className = `status-badge bg-${this.getStatusColor(status)}`;
        statusElement.textContent = this.getStatusText(status);
    }

    getStatusColor(status) {
        const colors = {
            normal: 'success',
            warning: 'warning',
            danger: 'danger',
            critical: 'danger'
        };
        return colors[status] || 'secondary';
    }

    getStatusText(status) {
        const texts = {
            normal: '正常',
            warning: '警告',
            danger: '危险',
            critical: '严重'
        };
        return texts[status] || '未知';
    }

    triggerAlert(parameter, level, message, value) {
        const alert = {
            id: Date.now(),
            parameter: parameter,
            level: level,
            message: message,
            value: value,
            timestamp: new Date(),
            acknowledged: false
        };

        this.currentAlerts.push(alert);
        this.addNotification(alert);
        this.updateCurrentAlerts();
        this.showAlertNotification(alert);
    }

    showAlertNotification(alert) {
        if (!this.alertSettings.enabled) return;

        const levelColors = {
            warning: '#ffc107',
            danger: '#dc3545',
            critical: '#6f42c1'
        };

        // 创建浏览器通知
        if (Notification.permission === 'granted') {
            new Notification('水质监测报警', {
                body: alert.message,
                icon: '/static/assets/img/logo.png',
                tag: alert.id
            });
        }

        // 显示页面内通知
        this.showToast(alert.message, alert.level);
    }

    showToast(message, level = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${level === 'critical' ? 'danger' : level} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    updateCurrentAlerts() {
        const container = document.getElementById('current-alerts');
        container.innerHTML = '';

        if (this.currentAlerts.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">暂无报警</div>';
            return;
        }

        this.currentAlerts.forEach(alert => {
            const alertElement = document.createElement('div');
            alertElement.className = `alert alert-${alert.level === 'critical' ? 'danger' : alert.level} alert-sm d-flex justify-content-between align-items-center`;
            alertElement.innerHTML = `
                <div>
                    <strong>${this.getParameterName(alert.parameter)}</strong>: ${alert.message}
                    <br><small class="text-muted">${alert.timestamp.toLocaleString()}</small>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="alertSystem.acknowledgeAlert(${alert.id})">
                    确认
                </button>
            `;
            container.appendChild(alertElement);
        });
    }

    acknowledgeAlert(alertId) {
        const alert = this.currentAlerts.find(a => a.id === alertId);
        if (alert) {
            alert.acknowledged = true;
            this.currentAlerts = this.currentAlerts.filter(a => a.id !== alertId);
            this.updateCurrentAlerts();
        }
    }

    addNotification(alert) {
        const notification = {
            id: alert.id,
            type: alert.level,
            message: alert.message,
            timestamp: alert.timestamp,
            read: false
        };

        this.notificationHistory.unshift(notification);
        if (this.notificationHistory.length > 100) {
            this.notificationHistory = this.notificationHistory.slice(0, 100);
        }

        this.updateNotificationHistory();
    }

    loadNotificationHistory() {
        const savedHistory = localStorage.getItem('notificationHistory');
        if (savedHistory) {
            this.notificationHistory = JSON.parse(savedHistory).map(n => ({
                ...n,
                timestamp: new Date(n.timestamp)
            }));
        }
        this.updateNotificationHistory();
    }

    updateNotificationHistory() {
        const container = document.getElementById('notification-history');
        const filter = document.querySelector('.btn-group .btn.active').dataset.filter;
        
        let filteredNotifications = this.notificationHistory;
        if (filter !== 'all') {
            filteredNotifications = this.notificationHistory.filter(n => n.type === filter);
        }

        if (filteredNotifications.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">暂无通知</div>';
            return;
        }

        container.innerHTML = '';
        filteredNotifications.forEach(notification => {
            const notificationElement = document.createElement('div');
            notificationElement.className = `notification-item ${notification.read ? '' : 'unread'} ${notification.type === 'critical' ? 'critical' : ''}`;
            notificationElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <span class="alert-indicator ${notification.type}"></span>
                            <strong>${this.getNotificationTitle(notification.type)}</strong>
                        </div>
                        <p class="mb-1">${notification.message}</p>
                        <small class="text-muted">${notification.timestamp.toLocaleString()}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="alertSystem.markAsRead(${notification.id})">
                        ${notification.read ? '已读' : '标记已读'}
                    </button>
                </div>
            `;
            container.appendChild(notificationElement);
        });

        // 保存到本地存储
        localStorage.setItem('notificationHistory', JSON.stringify(this.notificationHistory));
    }

    getNotificationTitle(type) {
        const titles = {
            warning: '警告通知',
            danger: '危险通知',
            critical: '严重报警',
            info: '信息通知'
        };
        return titles[type] || '通知';
    }

    markAsRead(notificationId) {
        const notification = this.notificationHistory.find(n => n.id === notificationId);
        if (notification) {
            notification.read = true;
            this.updateNotificationHistory();
        }
    }

    showNotification(message, type = 'info') {
        this.showToast(message, type);
    }

    bindEvents() {
        // 保存设置按钮
        document.getElementById('save-settings').addEventListener('click', () => {
            this.saveSettings();
        });

        // 通知过滤按钮
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.updateNotificationHistory();
            });
        });

        // 请求通知权限
        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }
}

// 初始化报警系统
let alertSystem;

// Fish Size Distribution Chart
var fishSizeOptions = {
    series: [{
        name: '数量',
        data: [30, 40, 45, 50, 49, 60, 70, 91]
    }],
    chart: {
        type: 'bar',
        height: 300
    },
    plotOptions: {
        bar: {
            horizontal: false,
            columnWidth: '55%',
            endingShape: 'rounded'
        },
    },
    dataLabels: {
        enabled: false
    },
    xaxis: {
        categories: ['0-3cm', '3-6cm', '6-9cm', '9-12cm', '12-15cm', '15-18cm', '18-21cm', '21cm+'],
    },
    title: {
        text: '鱼类大小分布图',
        align: 'center'
    }
};

var fishSizeChart = new ApexCharts(document.querySelector("#fishSizeChart"), fishSizeOptions);
fishSizeChart.render();

// Species Distribution Chart
var speciesOptions = {
    series: [44, 55, 13, 43, 22],
    chart: {
        type: 'pie',
        height: 300
    },
    labels: ['鲫鱼', '鲤鱼', '草鱼', '鲢鱼', '其他'],
    responsive: [{
        breakpoint: 480,
        options: {
            chart: {
                width: 200
            }
        }
    }]
};

var speciesChart = new ApexCharts(document.querySelector("#speciesChart"), speciesOptions);
speciesChart.render();

// System Status Chart
var systemStatusOptions = {
    series: [{
        name: 'CPU 使用率',
        data: [31, 40, 28, 51, 42, 45, 35, 28, 42, 56, 45, 47, 38, 42, 43, 45, 55, 57, 36, 48, 38, 42, 39]
    }, {
        name: '内存使用率',
        data: [45, 52, 38, 45, 48, 56, 52, 53, 41, 55, 58, 62, 55, 58, 53, 56, 62, 58, 55, 56, 52, 51, 49]
    }, {
        name: '网络流量',
        data: [12, 14, 15, 13, 28, 23, 24, 15, 23, 25, 32, 38, 32, 38, 32, 30, 35, 42, 37, 35, 28, 25, 23]
    }],
    chart: {
        height: 300,
        type: 'line',
        toolbar: {
            show: false
        },
        zoom: {
            enabled: false
        }
    },
    dataLabels: {
        enabled: false
    },
    stroke: {
        curve: 'smooth',
        width: 2
    },
    grid: {
        row: {
            colors: ['#f3f3f3', 'transparent'],
            opacity: 0.5
        },
    },
    xaxis: {
        categories: ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00'],
        labels: {
            rotateAlways: false,
            rotate: -45,
            style: {
                fontSize: '10px'
            }
        }
    },
    yaxis: {
        max: 100
    },
    tooltip: {
        y: {
            formatter: function (val) {
                return val + "%"
            }
        }
    },
    legend: {
        position: 'top'
    },
    title: {
        text: '过去24小时系统性能',
        align: 'left',
        style: {
            fontSize: '14px'
        }
    }
};

var systemStatusChart = new ApexCharts(document.querySelector("#systemStatusChart"), systemStatusOptions);
systemStatusChart.render();

// CPU Gauge
var cpuGaugeOptions = {
    series: [68],
    chart: {
        height: 120,
        type: 'radialBar',
    },
    plotOptions: {
        radialBar: {
            hollow: {
                size: '60%',
            },
            dataLabels: {
                show: true,
                name: {
                    show: false,
                },
                value: {
                    fontSize: '14px',
                    fontWeight: 'bold',
                    formatter: function (val) {
                        return val + '%';
                    }
                }
            }
        }
    },
    colors: ['#5e72e4'],
    stroke: {
        lineCap: 'round'
    }
};

var cpuGauge = new ApexCharts(document.querySelector("#cpuGauge"), cpuGaugeOptions);
cpuGauge.render();

// Memory Gauge
var memoryGaugeOptions = {
    series: [82],
    chart: {
        height: 120,
        type: 'radialBar',
    },
    plotOptions: {
        radialBar: {
            hollow: {
                size: '60%',
            },
            dataLabels: {
                show: true,
                name: {
                    show: false,
                },
                value: {
                    fontSize: '14px',
                    fontWeight: 'bold',
                    formatter: function (val) {
                        return val + '%';
                    }
                }
            }
        }
    },
    colors: ['#fb6340'],
    stroke: {
        lineCap: 'round'
    }
};

var memoryGauge = new ApexCharts(document.querySelector("#memoryGauge"), memoryGaugeOptions);
memoryGauge.render();

// Disk Gauge
var diskGaugeOptions = {
    series: [47],
    chart: {
        height: 120,
        type: 'radialBar',
    },
    plotOptions: {
        radialBar: {
            hollow: {
                size: '60%',
            },
            dataLabels: {
                show: true,
                name: {
                    show: false,
                },
                value: {
                    fontSize: '14px',
                    fontWeight: 'bold',
                    formatter: function (val) {
                        return val + '%';
                    }
                }
            }
        }
    },
    colors: ['#2dce89'],
    stroke: {
        lineCap: 'round'
    }
};

var diskGauge = new ApexCharts(document.querySelector("#diskGauge"), diskGaugeOptions);
diskGauge.render();

// Network Traffic Chart
var networkTrafficOptions = {
    series: [{
        name: '上传',
        data: [12, 15, 18, 10, 15, 22, 30, 28, 35, 25, 30, 20]
    }, {
        name: '下载',
        data: [35, 40, 30, 20, 25, 35, 45, 55, 40, 30, 35, 40]
    }],
    chart: {
        height: 200,
        type: 'area',
        toolbar: {
            show: false
        },
        zoom: {
            enabled: false
        }
    },
    dataLabels: {
        enabled: false
    },
    stroke: {
        curve: 'smooth',
        width: 2
    },
    fill: {
        type: 'gradient',
        gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.7,
            opacityTo: 0.3,
            stops: [0, 100]
        }
    },
    xaxis: {
        categories: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
        labels: {
            show: false
        }
    },
    yaxis: {
        labels: {
            formatter: function (value) {
                return value + " MB/s";
            }
        }
    },
    legend: {
        position: 'top'
    },
    tooltip: {
        y: {
            formatter: function (val) {
                return val + " MB/s"
            }
        }
    }
};

var networkTrafficChart = new ApexCharts(document.querySelector("#networkTrafficChart"), networkTrafficOptions);
networkTrafficChart.render();

// Device Map Chart
var deviceMapOptions = {
    series: [{
        name: 'Installations',
        data: [
            {
                x: '养殖区A',
                y: 5,
                goals: [
                    {
                        name: '监测设备',
                        value: 3,
                        strokeColor: '#2dce89'
                    },
                    {
                        name: '投饵设备',
                        value: 2,
                        strokeColor: '#5e72e4'
                    }
                ]
            },
            {
                x: '养殖区B',
                y: 7,
                goals: [
                    {
                        name: '监测设备',
                        value: 4,
                        strokeColor: '#2dce89'
                    },
                    {
                        name: '投饵设备',
                        value: 3,
                        strokeColor: '#5e72e4'
                    }
                ]
            },
            {
                x: '养殖区C',
                y: 3,
                goals: [
                    {
                        name: '监测设备',
                        value: 2,
                        strokeColor: '#2dce89'
                    },
                    {
                        name: '投饵设备',
                        value: 1,
                        strokeColor: '#5e72e4'
                    }
                ]
            },
            {
                x: '控制中心',
                y: 5,
                goals: [
                    {
                        name: '控制设备',
                        value: 5,
                        strokeColor: '#11cdef'
                    }
                ]
            },
            {
                x: '养殖区D',
                y: 6,
                goals: [
                    {
                        name: '监测设备',
                        value: 4,
                        strokeColor: '#2dce89'
                    },
                    {
                        name: '投饵设备',
                        value: 2,
                        strokeColor: '#5e72e4'
                    }
                ]
            }
        ]
    }],
    chart: {
        height: 350,
        type: 'bar',
        toolbar: {
            show: false
        }
    },
    plotOptions: {
        bar: {
            horizontal: true,
            distributed: true,
            barHeight: '80%',
            dataLabels: {
                position: 'bottom'
            }
        }
    },
    colors: ['#5e72e4', '#2dce89', '#11cdef', '#fb6340', '#f5365c'],
    dataLabels: {
        enabled: true,
        textAnchor: 'start',
        formatter: function(val, opt) {
            return opt.w.globals.labels[opt.dataPointIndex] + ": " + val;
        },
        offsetX: 0,
    },
    tooltip: {
        shared: false,
        intersect: true
    },
    xaxis: {
        title: {
            text: '设备数量'
        }
    },
    legend: {
        show: false
    },
    title: {
        text: '智能设备分布',
        align: 'left',
        style: {
            fontSize: '14px'
        }
    }
};

var deviceMapChart = new ApexCharts(document.querySelector("#deviceMapChart"), deviceMapOptions);
deviceMapChart.render();

// Water Quality Chart
var waterQualityOptions = {
    series: [{
        name: 'pH',
        data: [7.8, 7.7, 7.9, 8.0, 7.9, 7.8, 7.7]
    }, {
        name: '溶解氧 (mg/L)',
        data: [6.8, 7.2, 7.5, 7.3, 7.0, 6.9, 7.1]
    }, {
        name: '温度 (°C)',
        data: [24.5, 24.7, 25.2, 25.5, 25.3, 24.9, 24.7]
    }, {
        name: '盐度 (‰)',
        data: [33.2, 33.5, 33.4, 33.6, 33.8, 33.7, 33.5]
    }],
    chart: {
        height: 300,
        type: 'line',
        toolbar: {
            show: false
        },
        zoom: {
            enabled: false
        }
    },
    dataLabels: {
        enabled: false
    },
    stroke: {
        width: 2,
        curve: 'smooth'
    },
    grid: {
        row: {
            colors: ['#f3f3f3', 'transparent'],
            opacity: 0.5
        },
    },
    xaxis: {
        categories: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
    },
    yaxis: [
        {
            title: {
                text: 'pH值'
            },
            min: 7.0,
            max: 8.5
        },
        {
            opposite: true,
            title: {
                text: '其他参数'
            }
        }
    ],
    tooltip: {
        shared: true,
        intersect: false,
    },
    legend: {
        position: 'top'
    },
    title: {
        text: '过去一周水质参数变化',
        align: 'left',
        style: {
            fontSize: '14px'
        }
    }
};

var waterQualityChart = new ApexCharts(document.querySelector("#waterQualityChart"), waterQualityOptions);
waterQualityChart.render();

// Fish Health Chart
var fishHealthOptions = {
    series: [{
        name: '生长率',
        type: 'column',
        data: [12, 15, 18, 22, 20, 24, 28, 30]
    }, {
        name: '死亡率',
        type: 'line',
        data: [1.2, 1.1, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4]
    }, {
        name: '疾病发生率',
        type: 'line',
        data: [2.0, 1.8, 1.5, 1.2, 0.9, 0.6, 0.3, 0.2]
    }],
    chart: {
        height: 300,
        type: 'line',
        stacked: false,
        toolbar: {
            show: false
        }
    },
    dataLabels: {
        enabled: false
    },
    stroke: {
        width: [0, 2, 2],
        curve: 'smooth'
    },
    plotOptions: {
        bar: {
            columnWidth: '50%'
        }
    },
    colors: ['#2dce89', '#f5365c', '#fb6340'],
    xaxis: {
        categories: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月']
    },
    yaxis: [
        {
            seriesName: '生长率',
            title: {
                text: '生长率(%)'
            },
            min: 0
        },
        {
            seriesName: '死亡率',
            opposite: true,
            title: {
                text: '百分比(%)'
            },
            min: 0,
            max: 3
        },
        {
            seriesName: '疾病发生率',
            opposite: true,
            show: false
        }
    ],
    tooltip: {
        shared: true,
        intersect: false,
        y: {
            formatter: function (val, { seriesIndex, dataPointIndex, w }) {
                return val + '%';
            }
        }
    },
    legend: {
        position: 'top'
    },
    title: {
        text: '鱼群健康趋势',
        align: 'left',
        style: {
            fontSize: '14px'
        }
    }
};

var fishHealthChart = new ApexCharts(document.querySelector("#fishHealthChart"), fishHealthOptions);
fishHealthChart.render();

// Energy Consumption Chart
var energyConsumptionOptions = {
    series: [{
        name: '总能耗',
        data: [80, 95, 88, 92, 105, 110, 118, 85, 92, 98, 110, 95]
    }, {
        name: '投饵系统',
        data: [25, 30, 28, 30, 35, 38, 40, 28, 30, 32, 38, 30]
    }, {
        name: '监测系统',
        data: [22, 22, 23, 25, 25, 24, 25, 22, 23, 24, 25, 23]
    }, {
        name: '供氧系统',
        data: [33, 43, 37, 37, 45, 48, 53, 35, 39, 42, 47, 42]
    }],
    chart: {
        type: 'bar',
        height: 350,
        stacked: true,
        toolbar: {
            show: false
        }
    },
    plotOptions: {
        bar: {
            horizontal: false,
            columnWidth: '60%',
        },
    },
    dataLabels: {
        enabled: false
    },
    stroke: {
        width: 1,
        colors: ['#fff']
    },
    xaxis: {
        categories: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
    },
    yaxis: {
        title: {
            text: '能耗 (kWh)'
        },
    },
    fill: {
        opacity: 1
    },
    legend: {
        position: 'top'
    },
    colors: ['#5e72e4', '#2dce89', '#11cdef', '#fb6340'],
    title: {
        text: '年度能源消耗分布',
        align: 'left',
        style: {
            fontSize: '14px'
        }
    }
};

var energyConsumptionChart = new ApexCharts(document.querySelector("#energyConsumptionChart"), energyConsumptionOptions);
energyConsumptionChart.render();

// Maintenance Calendar
var maintenanceCalendarOptions = {
    series: [{
        name: '维护频率',
        data: [
            { x: '设备A', y: 3 },
            { x: '设备B', y: 5 },
            { x: '设备C', y: 1 },
            { x: '设备D', y: 2 },
            { x: '设备E', y: 4 },
            { x: '设备F', y: 0 },
            { x: '设备G', y: 3 }
        ]
    }],
    chart: {
        height: 150,
        type: 'heatmap',
        toolbar: {
            show: false
        }
    },
    plotOptions: {
        heatmap: {
            colorScale: {
                ranges: [{
                    from: 0,
                    to: 0,
                    color: '#F3F6F9',
                    name: '无'
                },
                {
                    from: 1,
                    to: 2,
                    color: '#9FCCF8',
                    name: '低'
                },
                {
                    from: 3,
                    to: 4,
                    color: '#5E72E4',
                    name: '中'
                },
                {
                    from: 5,
                    to: 6,
                    color: '#2558D2',
                    name: '高'
                }]
            }
        }
    },
    dataLabels: {
        enabled: false
    },
    stroke: {
        width: 2
    },
    title: {
        text: '本月设备维护频率',
        align: 'left',
        style: {
            fontSize: '14px'
        }
    },
    xaxis: {
        labels: {
            show: false
        }
    }
};

const toggleNotificationsBtn = document.getElementById('toggleNotifications');
const notificationContainer = document.getElementById('notification-history');

toggleNotificationsBtn.addEventListener('click', function() {
    notificationContainer.classList.toggle('collapsed');
    
    if (notificationContainer.classList.contains('collapsed')) {
        toggleNotificationsBtn.innerHTML = '<i class="fas fa-chevron-down"></i> 展开';
        // 添加延迟，等待过渡动画完成后再清空内容
        setTimeout(() => {
            if (notificationContainer.classList.contains('collapsed')) {
                // 保存当前内容到内存中
                notificationContainer.dataset.savedContent = notificationContainer.innerHTML;
                // 清空内容
                notificationContainer.innerHTML = '';
            }
        }, 300); // 与CSS过渡时间匹配
    } else {
        toggleNotificationsBtn.innerHTML = '<i class="fas fa-chevron-up"></i> 收起';
        // 如果有保存的内容，恢复它
        if (notificationContainer.dataset.savedContent) {
            notificationContainer.innerHTML = notificationContainer.dataset.savedContent;
        } else {
            // 如果没有保存的内容，重新加载通知历史
            alertSystem.updateNotificationHistory();
        }
        // 滚动到顶部
        setTimeout(() => {
            notificationContainer.scrollTop = 0;
        }, 10);
    }
});

var maintenanceCalendar = new ApexCharts(document.querySelector("#maintenanceCalendar"), maintenanceCalendarOptions);
maintenanceCalendar.render();

// Search Function
document.getElementById('searchButton').addEventListener('click', function() {
    var searchValue = document.getElementById('searchInput').value;
    // 实现搜索逻辑
    console.log('搜索关键词:', searchValue);
    alert('正在搜索: ' + searchValue);
});

// Page Load Complete Initialization
document.addEventListener('DOMContentLoaded', function() {
    alertSystem = new AlertNotificationSystem();
});
</script>
{% endblock javascripts %}